#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–û–ó–î–ê–ù–ò–ï –§–ò–ù–ê–õ–¨–ù–û–ì–û –û–ë–™–ï–î–ò–ù–ï–ù–ù–û–ì–û –û–¢–ß–ï–¢–ê
–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
"""

import pandas as pd
import numpy as np
from pathlib import Path

def create_final_unified_report():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
    
    print("üéØ –°–û–ó–î–ê–ù–ò–ï –§–ò–ù–ê–õ–¨–ù–û–ì–û –û–ë–™–ï–î–ò–ù–ï–ù–ù–û–ì–û –û–¢–ß–ï–¢–ê")
    print("=" * 60)
    
    # 1. –ß–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    df_original = pd.read_excel('ENHANCED_CATEGORIES_RANGES.xlsx', sheet_name='–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ_–¥–∏–∞–ø–∞–∑–æ–Ω—ã')
    print(f"üìä –ò—Å—Ö–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: {len(df_original)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π, {df_original['–¢–æ–≤–∞—Ä–æ–≤'].sum():,} —Ç–æ–≤–∞—Ä–æ–≤")
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
    df_original['–ï—Å—Ç—å_–¥–∏–∞–ø–∞–∑–æ–Ω—ã_–ë–î'] = (
        df_original['–¶–µ–Ω–∞_—Ä—É–±_–º–∏–Ω'].notna() | 
        df_original['–¢–∏—Ä–∞–∂_–º–∏–Ω'].notna() | 
        df_original['–ü–ª–æ—Ç–Ω–æ—Å—Ç—å_–º–∏–Ω'].notna()
    )
    
    df_original['–ï—Å—Ç—å_–¥–∞–Ω–Ω—ã–µ_CSV'] = df_original['–ü–æ–ø—É–ª—è—Ä–Ω–∞—è_–∫–∞—Ç–µ–≥–æ—Ä–∏—è'].notna()
    
    df_original['–ï—Å—Ç—å_—Å—Ç–∞–≤–∫–∏_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = (
        df_original['–°—Ç–∞–≤–∫–∞_–∂–¥_–±–∞–∑–æ–≤–∞—è'].notna() | 
        df_original['–°—Ç–∞–≤–∫–∞_–∞–≤–∏–∞_–±–∞–∑–æ–≤–∞—è'].notna()
    )
    
    def get_completeness_category(row):
        has_db = row['–ï—Å—Ç—å_–¥–∏–∞–ø–∞–∑–æ–Ω—ã_–ë–î']
        has_csv = row['–ï—Å—Ç—å_–¥–∞–Ω–Ω—ã–µ_CSV']
        has_rates = row['–ï—Å—Ç—å_—Å—Ç–∞–≤–∫–∏_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç']
        
        if has_db and has_csv and has_rates:
            return "üü¢ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï"
        elif has_db and has_csv:
            return "üü° –ë–î + CSV (–Ω–µ—Ç —Å—Ç–∞–≤–æ–∫)"
        elif has_db and not has_csv:
            return "üîµ –¢–û–õ–¨–ö–û –ë–î"
        elif not has_db and has_csv:
            return "üü† –¢–û–õ–¨–ö–û CSV"
        else:
            return "üî¥ –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï"
    
    df_original['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] = df_original.apply(get_completeness_category, axis=1)
    
    # 2. –ß–∏—Ç–∞–µ–º –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ CSV
    df_enhanced_csv = pd.read_excel('ENHANCED_CSV_CATEGORIES.xlsx', sheet_name='–î–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏')
    print(f"üìä –î–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ CSV: {len(df_enhanced_csv)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π, {df_enhanced_csv['–¢–æ–≤–∞—Ä–æ–≤'].sum():,} —Ç–æ–≤–∞—Ä–æ–≤")
    
    # 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    # –£–¥–∞–ª—è–µ–º –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω—ã
    enhanced_categories = set(df_enhanced_csv['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].values)
    df_original_filtered = df_original[~df_original['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].isin(enhanced_categories)].copy()
    
    print(f"üìä –ü–æ—Å–ª–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–µ–π: {len(df_original_filtered)} –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º
    df_unified = pd.concat([df_original_filtered, df_enhanced_csv], ignore_index=True)
    print(f"‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: {len(df_unified)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π, {df_unified['–¢–æ–≤–∞—Ä–æ–≤'].sum():,} —Ç–æ–≤–∞—Ä–æ–≤")
    
    # 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
    df_unified['–ï—Å—Ç—å_–¥–∏–∞–ø–∞–∑–æ–Ω—ã_–ë–î'] = (
        df_unified['–¶–µ–Ω–∞_—Ä—É–±_–º–∏–Ω'].notna() | 
        df_unified['–¢–∏—Ä–∞–∂_–º–∏–Ω'].notna() | 
        df_unified['–ü–ª–æ—Ç–Ω–æ—Å—Ç—å_–º–∏–Ω'].notna()
    )
    
    df_unified['–ï—Å—Ç—å_–¥–∞–Ω–Ω—ã–µ_CSV'] = df_unified['–ü–æ–ø—É–ª—è—Ä–Ω–∞—è_–∫–∞—Ç–µ–≥–æ—Ä–∏—è'].notna()
    
    df_unified['–ï—Å—Ç—å_—Å—Ç–∞–≤–∫–∏_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = (
        df_unified['–°—Ç–∞–≤–∫–∞_–∂–¥_–±–∞–∑–æ–≤–∞—è'].notna() | 
        df_unified['–°—Ç–∞–≤–∫–∞_–∞–≤–∏–∞_–±–∞–∑–æ–≤–∞—è'].notna()
    )
    
    df_unified['–ï—Å—Ç—å_–º–∞—Ç–µ—Ä–∏–∞–ª—ã'] = df_unified['–ú–∞—Ç–µ—Ä–∏–∞–ª_—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π'].notna()
    df_unified['–ï—Å—Ç—å_—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã'] = df_unified['–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã_—Ç—Ä–µ–±—É–µ–º—ã–µ'].notna()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª–Ω–æ—Ç—ã
    
    df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] = df_unified.apply(get_completeness_category, axis=1)
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
    df_unified['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤'] = (
        df_unified['–¶–µ–Ω–∞_—Ä—É–±_–º–∏–Ω'].notna().astype(int) +
        df_unified['–¶–µ–Ω–∞_—é–∞–Ω—å_–º–∏–Ω'].notna().astype(int) +
        df_unified['–¢–∏—Ä–∞–∂_–º–∏–Ω'].notna().astype(int) +
        df_unified['–ü–ª–æ—Ç–Ω–æ—Å—Ç—å_–º–∏–Ω'].notna().astype(int) +
        df_unified['–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç_–º–∏–Ω'].notna().astype(int)
    )
    
    # 5. –°–æ–∑–¥–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å–≤–æ–¥–∫–∏
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã
    completeness_stats = df_unified.groupby('–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö').agg({
        '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': 'count',
        '–¢–æ–≤–∞—Ä–æ–≤': ['sum', 'mean']
    }).round(1)
    completeness_stats.columns = ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π', '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤', '–°—Ä–µ–¥–Ω–µ_—Ç–æ–≤–∞—Ä–æ–≤']
    completeness_stats = completeness_stats.reset_index()
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ª–Ω–æ—Ç–µ –¥–∞–Ω–Ω—ã—Ö
    completeness_order = {
        "üü¢ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï": 1,
        "üü° –ë–î + CSV (–Ω–µ—Ç —Å—Ç–∞–≤–æ–∫)": 2, 
        "üîµ –¢–û–õ–¨–ö–û –ë–î": 3,
        "üü† –¢–û–õ–¨–ö–û CSV": 4,
        "üî¥ –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï": 5
    }
    
    df_unified['sort_order'] = df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'].map(completeness_order)
    df_unified = df_unified.sort_values(['sort_order', '–¢–æ–≤–∞—Ä–æ–≤'], ascending=[True, False])
    df_unified = df_unified.drop('sort_order', axis=1)
    
    # 6. –°–≤–æ–¥–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
    summary_columns = [
        '–¢–∏–ø', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–†–æ–¥–∏—Ç–µ–ª—å', '–¢–æ–≤–∞—Ä–æ–≤', '–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö',
        '–ü–æ–ø—É–ª—è—Ä–Ω–∞—è_–∫–∞—Ç–µ–≥–æ—Ä–∏—è', '–ú–∞—Ç–µ—Ä–∏–∞–ª_—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π', 
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤', '–ï—Å—Ç—å_–¥–∏–∞–ø–∞–∑–æ–Ω—ã_–ë–î', '–ï—Å—Ç—å_–¥–∞–Ω–Ω—ã–µ_CSV',
        '–ï—Å—Ç—å_—Å—Ç–∞–≤–∫–∏_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ï—Å—Ç—å_–º–∞—Ç–µ—Ä–∏–∞–ª—ã', '–ï—Å—Ç—å_—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã',
        '–ú–µ–¥–∏–∞–Ω–∞_—Ü–µ–Ω—ã_—Ä—É–±', '–ú–µ–¥–∏–∞–Ω–∞_–ø–ª–æ—Ç–Ω–æ—Å—Ç–∏', '–ú–µ–¥–∏–∞–Ω–∞_—Ç–∏—Ä–∞–∂–∞',
        '–°—Ç–∞–≤–∫–∞_–∂–¥_–±–∞–∑–æ–≤–∞—è', '–°—Ç–∞–≤–∫–∞_–∞–≤–∏–∞_–±–∞–∑–æ–≤–∞—è', '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã_—Ç—Ä–µ–±—É–µ–º—ã–µ'
    ]
    
    df_summary = df_unified[summary_columns].copy()
    
    # –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    comparison_stats = pd.DataFrame([{
        '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–î–û –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è',
        '–í—Å–µ–≥–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π': len(df_original),
        '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤': df_original['–¢–æ–≤–∞—Ä–æ–≤'].sum(),
        '–ü–æ–ª–Ω—ã—Ö_–¥–∞–Ω–Ω—ã—Ö': len(df_original[df_original['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü¢ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï"]),
        '–ë–î_–ø–ª—é—Å_CSV': len(df_original[df_original['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü° –ë–î + CSV (–Ω–µ—Ç —Å—Ç–∞–≤–æ–∫)"]),
        '–¢–æ–ª—å–∫–æ_–ë–î': len(df_original[df_original['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üîµ –¢–û–õ–¨–ö–û –ë–î"]),
        '–¢–æ–ª—å–∫–æ_CSV': len(df_original[df_original['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü† –¢–û–õ–¨–ö–û CSV"])
    }, {
        '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–ü–û–°–õ–ï –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è',
        '–í—Å–µ–≥–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π': len(df_unified),
        '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤': df_unified['–¢–æ–≤–∞—Ä–æ–≤'].sum(),
        '–ü–æ–ª–Ω—ã—Ö_–¥–∞–Ω–Ω—ã—Ö': len(df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü¢ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï"]),
        '–ë–î_–ø–ª—é—Å_CSV': len(df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü° –ë–î + CSV (–Ω–µ—Ç —Å—Ç–∞–≤–æ–∫)"]),
        '–¢–æ–ª—å–∫–æ_–ë–î': len(df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üîµ –¢–û–õ–¨–ö–û –ë–î"]),
        '–¢–æ–ª—å–∫–æ_CSV': len(df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü† –¢–û–õ–¨–ö–û CSV"])
    }])
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
    numeric_cols = ['–í—Å–µ–≥–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π', '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤', '–ü–æ–ª–Ω—ã—Ö_–¥–∞–Ω–Ω—ã—Ö', '–ë–î_–ø–ª—é—Å_CSV', '–¢–æ–ª—å–∫–æ_–ë–î', '–¢–æ–ª—å–∫–æ_CSV']
    changes = {}
    changes['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] = '–ò–ó–ú–ï–ù–ï–ù–ò–Ø (+/-)'
    
    for col in numeric_cols:
        changes[col] = comparison_stats.loc[1, col] - comparison_stats.loc[0, col]
    
    comparison_stats.loc[2] = pd.Series(changes)
    
    # 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    output_file = Path(__file__).parent / "FINAL_UNIFIED_ANALYSIS.xlsx"
    
    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        # 1. –û—Å–Ω–æ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞
        df_summary.to_excel(writer, sheet_name='üìä_–ò—Ç–æ–≥–æ–≤–∞—è_—Å–≤–æ–¥–∫–∞', index=False)
        
        # 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è)
        completeness_stats.to_excel(writer, sheet_name='üìà_–ù–æ–≤–∞—è_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', index=False)
        
        # 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ
        comparison_stats.to_excel(writer, sheet_name='üîÑ_–°—Ä–∞–≤–Ω–µ–Ω–∏–µ_–∏–∑–º–µ–Ω–µ–Ω–∏–π', index=False)
        
        # 4. –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
        full_data = df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü¢ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï"]
        if len(full_data) > 0:
            full_data.to_excel(writer, sheet_name='üü¢_–ü–æ–ª–Ω—ã–µ_–¥–∞–Ω–Ω—ã–µ_–ò–¢–û–ì', index=False)
        
        # 5. –ë–î + CSV –±–µ–∑ —Å—Ç–∞–≤–æ–∫
        partial_data = df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü° –ë–î + CSV (–Ω–µ—Ç —Å—Ç–∞–≤–æ–∫)"]
        if len(partial_data) > 0:
            partial_data.to_excel(writer, sheet_name='üü°_–ë–î_–ø–ª—é—Å_CSV_–ò–¢–û–ì', index=False)
        
        # 6. –¢–æ–ª—å–∫–æ –ë–î (—É–º–µ–Ω—å—à–∏–ª–æ—Å—å)
        db_only = df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üîµ –¢–û–õ–¨–ö–û –ë–î"]
        if len(db_only) > 0:
            db_only.to_excel(writer, sheet_name='üîµ_–¢–æ–ª—å–∫–æ_–ë–î_–ò–¢–û–ì', index=False)
        
        # 7. –¢–æ–ª—å–∫–æ CSV (–¥–æ–ª–∂–Ω–æ —Å—Ç–∞—Ç—å –º–µ–Ω—å—à–µ)
        csv_only = df_unified[df_unified['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö'] == "üü† –¢–û–õ–¨–ö–û CSV"]
        if len(csv_only) > 0:
            csv_only.to_excel(writer, sheet_name='üü†_–¢–æ–ª—å–∫–æ_CSV_–ò–¢–û–ì', index=False)
        
        # 8. –¢–û–ü –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–≤–∞—Ä–æ–≤
        top_categories = df_unified.nlargest(50, '–¢–æ–≤–∞—Ä–æ–≤')[summary_columns]
        top_categories.to_excel(writer, sheet_name='üèÜ_–¢–û–ü_50_–∫–∞—Ç–µ–≥–æ—Ä–∏–π', index=False)
        
        # 9. –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
        df_unified.to_excel(writer, sheet_name='üìã_–ü–æ–ª–Ω–∞—è_–∏—Ç–æ–≥–æ–≤–∞—è', index=False)
    
    print(f"‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {output_file}")
    print()
    print("üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–õ–ù–û–¢–´:")
    for _, row in completeness_stats.iterrows():
        print(f"  {row['–ü–æ–ª–Ω–æ—Ç–∞_–¥–∞–Ω–Ω—ã—Ö']}: {row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π']} –∫–∞—Ç–µ–≥–æ—Ä–∏–π, {row['–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤']:,.0f} —Ç–æ–≤–∞—Ä–æ–≤")
    
    print()
    print("üîÑ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–û–°–õ–ï –£–ú–ù–û–ì–û –ü–û–ò–°–ö–ê:")
    for col in ['–í—Å–µ–≥–æ_–∫–∞—Ç–µ–≥–æ—Ä–∏–π', '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤', '–ü–æ–ª–Ω—ã—Ö_–¥–∞–Ω–Ω—ã—Ö', '–ë–î_–ø–ª—é—Å_CSV', '–¢–æ–ª—å–∫–æ_CSV']:
        change = comparison_stats.loc[2, col]
        if col == '–í—Å–µ–≥–æ_—Ç–æ–≤–∞—Ä–æ–≤':
            print(f"  {col}: {change:+,}")
        else:
            print(f"  {col}: {change:+}")
    
    # –°–æ–∑–¥–∞–µ–º CSV –≤–µ—Ä—Å–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤
    df_summary.to_csv('FINAL_UNIFIED_SUMMARY.csv', index=False, encoding='utf-8')
    completeness_stats.to_csv('FINAL_COMPLETENESS_STATS.csv', index=False, encoding='utf-8')
    comparison_stats.to_csv('BEFORE_AFTER_COMPARISON.csv', index=False, encoding='utf-8')
    
    print()
    print("üìÑ CSV –§–ê–ô–õ–´:")
    print("  ‚Ä¢ FINAL_UNIFIED_SUMMARY.csv - –∏—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞")
    print("  ‚Ä¢ FINAL_COMPLETENESS_STATS.csv - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    print("  ‚Ä¢ BEFORE_AFTER_COMPARISON.csv - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ")
    
    return df_unified

if __name__ == "__main__":
    create_final_unified_report()
