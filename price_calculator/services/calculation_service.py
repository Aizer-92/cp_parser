"""
–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞–º–∏

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ PriceCalculator
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤ –≤ –ë–î
- –ó–∞–≥—Ä—É–∑–∫—É —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–∑ –ë–î
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞–º–∏
"""

from typing import Optional, Dict, Any
from datetime import datetime

from price_calculator import PriceCalculator
from database import save_calculation_to_db, update_calculation, get_calculation_history


class CalculationService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞–º–∏ —Ü–µ–Ω"""
    
    def __init__(self):
        self.calculator = PriceCalculator()
    
    def perform_calculation(
        self,
        product_name: str,
        price_yuan: float,
        quantity: int,
        markup: float = 1.7,
        weight_kg: Optional[float] = None,
        custom_rate: Optional[float] = None,
        delivery_type: str = "rail",
        product_url: str = "",
        # –î–∞–Ω–Ω—ã–µ –ø–∞–∫–∏–Ω–≥–∞
        packing_units_per_box: Optional[int] = None,
        packing_box_weight: Optional[float] = None,
        packing_box_length: Optional[float] = None,
        packing_box_width: Optional[float] = None,
        packing_box_height: Optional[float] = None,
        # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
        custom_logistics: Optional[Dict[str, Any]] = None,
        forced_category: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
        
        Args:
            product_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            price_yuan: –¶–µ–Ω–∞ –≤ —é–∞–Ω—è—Ö
            quantity: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            markup: –ù–∞—Ü–µ–Ω–∫–∞ (default: 1.7)
            ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
        
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ (dict)
        """
        return self.calculator.calculate_cost(
            product_name=product_name,
            price_yuan=price_yuan,
            weight_kg=weight_kg,
            quantity=quantity,
            custom_rate=custom_rate,
            delivery_type=delivery_type,
            markup=markup,
            product_url=product_url,
            packing_units_per_box=packing_units_per_box,
            packing_box_weight=packing_box_weight,
            packing_box_length=packing_box_length,
            packing_box_width=packing_box_width,
            packing_box_height=packing_box_height,
            custom_logistics_params=custom_logistics,
            forced_category=forced_category
        )
    
    def create_calculation(
        self,
        calculation_result: Dict[str, Any],
        custom_logistics: Optional[Dict[str, Any]] = None,
        forced_category: Optional[str] = None
    ) -> int:
        """
        –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç –≤ –ë–î
        
        Args:
            calculation_result: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç calculator.calculate_cost()
            custom_logistics: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
            forced_category: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        
        Returns:
            ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
        """
        db_data = self._prepare_db_data(
            calculation_result,
            custom_logistics=custom_logistics,
            forced_category=forced_category
        )
        
        return save_calculation_to_db(db_data)
    
    def update_calculation(
        self,
        calculation_id: int,
        calculation_result: Dict[str, Any],
        custom_logistics: Optional[Dict[str, Any]] = None,
        forced_category: Optional[str] = None
    ) -> bool:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–∞—Å—á—ë—Ç –≤ –ë–î
        
        Args:
            calculation_id: ID —Ä–∞—Å—á—ë—Ç–∞
            calculation_result: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç calculator.calculate_cost()
            custom_logistics: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
            forced_category: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            print(f"üîÑ CalculationService.update_calculation: ID={calculation_id}")
            print(f"   calculation_result keys: {list(calculation_result.keys())}")
            print(f"   custom_logistics: {custom_logistics is not None}")
            print(f"   forced_category: {forced_category}")
            
            db_data = self._prepare_db_data(
                calculation_result,
                custom_logistics=custom_logistics,
                forced_category=forced_category
            )
            
            print(f"‚úÖ db_data –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ: {len(db_data)} –ø–æ–ª–µ–π")
            
            update_calculation(calculation_id, db_data)
            print(f"‚úÖ update_calculation –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ")
            return True
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ CalculationService.update_calculation: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    def _prepare_db_data(
        self,
        result: Dict[str, Any],
        custom_logistics: Optional[Dict[str, Any]] = None,
        forced_category: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
        
        Args:
            result: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç calculator.calculate_cost()
            custom_logistics: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
            forced_category: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        
        Returns:
            –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è save_calculation_to_db/update_calculation
        """
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å fallback
            # –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º `or {}` —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å None
            packing_data = result.get('packing') or {}
            customs_info = result.get('customs_info') or {}
            customs_calc = result.get('customs_calculations') or {}
            density_warning = result.get('density_warning') or {}
            
            return {
                'product_name': result.get('product_name', ''),
                'category': result.get('category', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'),
                'price_yuan': result.get('unit_price_yuan', 0),
                'weight_kg': result.get('weight_kg', 0),
                'quantity': result.get('quantity', 0),
                'markup': result.get('markup', 1.7),
                'custom_rate': result.get('logistics', {}).get('rate_usd') if result.get('logistics') else None,
                'product_url': result.get('product_url', ''),
                # –í–ê–ñ–ù–û: database.py –æ–∂–∏–¥–∞–µ—Ç –∫–ª—é—á–∏ –ë–ï–ó _total!
                'cost_price_rub': result.get('cost_price', {}).get('total', {}).get('rub', 0),
                'cost_price_usd': result.get('cost_price', {}).get('total', {}).get('usd', 0),
                'sale_price_rub': result.get('sale_price', {}).get('total', {}).get('rub', 0),
                'sale_price_usd': result.get('sale_price', {}).get('total', {}).get('usd', 0),
                'profit_rub': result.get('profit', {}).get('total', {}).get('rub', 0),
                'profit_usd': result.get('profit', {}).get('total', {}).get('usd', 0),
                'calculation_type': result.get('calculation_type', 'quick'),
                # –î–∞–Ω–Ω—ã–µ –ø–∞–∫–∏–Ω–≥–∞ (—Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º)
                'packing_units_per_box': packing_data.get('units_per_box'),
                'packing_box_weight': packing_data.get('box_weight_kg'),
                'packing_box_length': packing_data.get('box_length_cm'),
                'packing_box_width': packing_data.get('box_width_cm'),
                'packing_box_height': packing_data.get('box_height_cm'),
                'packing_total_boxes': packing_data.get('total_boxes'),
                'packing_total_volume': packing_data.get('total_volume_m3'),
                'packing_total_weight': packing_data.get('total_weight_kg'),
                # –î–∞–Ω–Ω—ã–µ –æ –ø–æ—à–ª–∏–Ω–∞—Ö
                'tnved_code': customs_info.get('tnved_code'),
                'duty_rate': customs_info.get('duty_rate'),
                'vat_rate': customs_info.get('vat_rate'),
                'duty_amount_usd': customs_calc.get('duty_amount_usd'),
                'vat_amount_usd': customs_calc.get('vat_amount_usd'),
                'total_customs_cost_usd': customs_calc.get('total_customs_cost_usd'),
                'certificates': ', '.join(customs_info.get('certificates', [])) if customs_info.get('certificates') else None,
                'customs_notes': customs_info.get('required_documents'),
                # –î–∞–Ω–Ω—ã–µ –æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
                'density_warning_message': density_warning.get('message'),
                'calculated_density': density_warning.get('calculated_density'),
                'category_density': density_warning.get('category_density'),
                # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                'custom_logistics': custom_logistics,
                'forced_category': forced_category
            }
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ _prepare_db_data: {e}")
            print(f"   result keys: {list(result.keys()) if result else 'None'}")
            import traceback
            traceback.print_exc()
            raise
    
    def get_calculation_history(self, limit: int = 50) -> list:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–∑ –ë–î
        
        Args:
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤
        """
        return get_calculation_history()


# Singleton instance
_calculation_service = None

def get_calculation_service() -> CalculationService:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç singleton instance CalculationService"""
    global _calculation_service
    if _calculation_service is None:
        _calculation_service = CalculationService()
    return _calculation_service

