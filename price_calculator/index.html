<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Calculator - Калькулятор цен товаров</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 0;
            margin-bottom: 24px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .nav {
            display: flex;
            gap: 8px;
        }
        
        .nav-button {
            padding: 8px 16px;
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .nav-button.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .nav-button:hover:not(.active) {
            border-color: #9ca3af;
        }
        
        .logout-button {
            padding: 8px 16px;
            background: none;
            border: 1px solid #dc2626;
            color: #dc2626;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .logout-button:hover {
            background: #dc2626;
            color: white;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .card-subtitle {
            color: #6b7280;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .grid {
            display: grid;
            gap: 16px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        .category-info {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .markup-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .markup-button {
            padding: 4px 12px;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .markup-button:hover {
            background: #f3f4f6;
        }
        
        .markup-button.active {
            background: #1f2937;
            color: white;
            border-color: #1f2937;
        }
        
        .submit-button {
            width: 100%;
            padding: 12px 24px;
            background: #000;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 16px;
        }
        
        .submit-button:hover:not(:disabled) {
            background: #1f2937;
        }
        
        .submit-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results {
            margin-top: 24px;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .metric-title {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .metric-secondary {
            font-size: 14px;
            color: #6b7280;
        }
        
        .metric-unit {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .detail-group {
            background: #f9fafb;
            border-radius: 6px;
            padding: 16px;
        }
        
        .detail-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .detail-label {
            color: #6b7280;
            font-size: 13px;
        }
        
        .detail-value {
            font-weight: 500;
            color: #1f2937;
            font-size: 13px;
        }
        
        .history {
            margin-top: 24px;
        }
        
        .history-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .history-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .history-summary {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-main-info h3 {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .history-main-info p {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .history-prices {
            text-align: right;
        }
        
        .history-yuan-price {
            font-size: 14px;
            color: #059669;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .history-unit-price {
            font-size: 16px;
            color: #1f2937;
            font-weight: 600;
        }
        
        .history-details {
            border-top: 1px solid #f3f4f6;
            padding: 16px;
            background: #f9fafb;
            border-radius: 0 0 6px 6px;
        }
        
        .history-expand-icon {
            margin-left: 8px;
            font-size: 12px;
            color: #6b7280;
            transition: transform 0.2s ease;
        }
        
        .history-expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .history-values {
            text-align: right;
        }
        
        .history-price {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .history-profit {
            font-size: 13px;
            color: #059669;
        }
        
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }
        
        .empty-icon {
            width: 64px;
            height: 64px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
            color: #9ca3af;
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        .slide-up-enter-active {
            transition: all 0.3s ease-out;
        }
        .slide-up-enter-from {
            transform: translateY(20px);
            opacity: 0;
        }
        
        .refresh-button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .refresh-button:hover {
            border-color: #9ca3af;
        }
    </style>
</head>
<body>
    <div id="app">
        
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">Price Calculator</div>
                    <nav class="nav">
                        <button @click="activeTab = 'calculator'" 
                                :class="['nav-button', { active: activeTab === 'calculator' }]">
                            Калькулятор
                        </button>
                        <button @click="activeTab = 'history'" 
                                :class="['nav-button', { active: activeTab === 'history' }]">
                            История
                        </button>
                        <button @click="logout" class="logout-button">
                            Выход
                        </button>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container">
            
            <!-- Calculator Tab -->
            <div v-if="activeTab === 'calculator'">
                
                <!-- Input Form -->
                <div class="card">
                    <h2 class="card-title">Расчет стоимости товара</h2>
                    <p class="card-subtitle">Введите данные о товаре для расчета себестоимости и цены продажи</p>
                    
                    <form @submit.prevent="calculatePrice">
                        
                        <!-- Product Name -->
                        <div class="form-group">
                            <label class="form-label">Название товара</label>
                            <input v-model="form.product_name" 
                                   @input="onProductNameChange"
                                   type="text" 
                                   placeholder="Введите название товара для автоопределения категории"
                                   class="form-input"
                                   required>
                        </div>
                        
                            <!-- Category Selection -->
                            <div v-if="detectedCategory" class="category-info">
                                <div class="form-group">
                                    <label class="form-label">Категория товара</label>
                                    <select v-model="selectedCategoryIndex" 
                                            @change="onCategoryChange"
                                            class="form-select"
                                            style="height: auto; padding: 12px;">
                                        <option v-for="(category, index) in categories" :key="index" :value="index"
                                                style="padding: 8px 0; line-height: 1.4;">
                                            {{ getCleanCategoryName(category.category) }}
                                            <span style="color: #6b7280; font-size: 0.9em;">
                                                ({{ category.material }})
                                            </span>
                                        </option>
                                    </select>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                        Плотность: {{ detectedCategory.density.toFixed(0) }} кг/м³
                                        • Ставка ЖД: ${{ detectedCategory.rates.rail_base }}
                                        • Авиа: ${{ detectedCategory.rates.air_base }}
                                    </div>
                                </div>
                            </div>
                        
                        <div class="grid grid-2">
                            <!-- Product URL -->
                            <div class="form-group">
                                <label class="form-label">Ссылка или wechat</label>
                                <input v-model="form.product_url" 
                                       type="text" 
                                       placeholder="https://example.com/product или wechat ID или любой текст"
                                       class="form-input">
                            </div>
                            
                            <!-- Price Yuan -->
                            <div class="form-group">
                                <label class="form-label">Цена за единицу (юань)</label>
                                <input v-model.number="form.price_yuan" 
                                       type="number" 
                                       step="0.01"
                                       placeholder="0.00"
                                       class="form-input"
                                       required>
                            </div>
                            
                            <!-- Weight -->
                            <div class="form-group">
                                <label class="form-label">Вес единицы товара (кг)</label>
                                <input v-model.number="form.weight_kg" 
                                       type="number" 
                                       step="0.001"
                                       placeholder="0.000"
                                       class="form-input"
                                       required>
                            </div>
                            
                            <!-- Quantity -->
                            <div class="form-group">
                                <label class="form-label">Количество (тираж)</label>
                                <input v-model.number="form.quantity" 
                                       type="number"
                                       min="1"
                                       placeholder="1"
                                       class="form-input"
                                       required>
                            </div>
                        </div>
                        
                        <div class="grid grid-2">
                            <!-- Delivery Type -->
                            <div class="form-group">
                                <label class="form-label">Тип доставки</label>
                                <select v-model="form.delivery_type" 
                                        @change="updateSuggestedRate"
                                        class="form-select">
                                    <option value="rail">Ж/Д (железная дорога)</option>
                                    <option value="air">Авиа</option>
                                </select>
                            </div>
                            
                            <!-- Logistics Rate -->
                            <div class="form-group">
                                <label class="form-label">Логистическая ставка ($/кг)</label>
                                <input v-model.number="form.custom_rate" 
                                       type="number" 
                                       step="0.1"
                                       placeholder="0.0"
                                       class="form-input">
                                <div v-if="suggestedRate > 0" style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                    Предлагаемая ставка: ${{ suggestedRate.toFixed(1) }}/кг
                                </div>
                            </div>
                        </div>
                        
                        <!-- Markup -->
                        <div class="form-group">
                            <label class="form-label">Наценка (множитель)</label>
                            <input v-model.number="form.markup" 
                                   type="number" 
                                   step="0.1"
                                   min="1"
                                   class="form-input">
                            <div class="markup-buttons">
                                <button type="button" @click="form.markup = 1.3" 
                                        :class="['markup-button', { active: form.markup === 1.3 }]">1.3</button>
                                <button type="button" @click="form.markup = 1.5" 
                                        :class="['markup-button', { active: form.markup === 1.5 }]">1.5</button>
                                <button type="button" @click="form.markup = 1.7" 
                                        :class="['markup-button', { active: form.markup === 1.7 }]">1.7</button>
                                <button type="button" @click="form.markup = 2.0" 
                                        :class="['markup-button', { active: form.markup === 2.0 }]">2.0</button>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                Наценка {{ ((form.markup - 1) * 100).toFixed(0) }}% • Цена будет в {{ form.markup }} раз больше себестоимости
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" 
                                :disabled="isCalculating || !isFormValid"
                                class="submit-button">
                            <span v-if="isCalculating">
                                <span class="loading"></span>
                                Расчитываю...
                            </span>
                            <span v-else>
                                Рассчитать стоимость
                            </span>
                        </button>
                    </form>
                </div>
                
                <!-- Results -->
                <transition name="slide-up">
                    <div v-if="result" class="results">
                        <div class="card">
                            <h2 class="card-title">Результат расчета</h2>
                            <p class="card-subtitle">{{ result.product_name }}</p>
                            
                            <!-- Database Warning for Calculator -->
                            <div v-if="!databaseAvailable" style="background: #fef3cd; border: 1px solid #fde68a; color: #92400e; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 14px;">
                                ⚠️ Расчет выполнен, но не сохранен в истории (БД недоступна)
                            </div>
                            
                            <!-- Price Per Unit (Main for Client) -->
                            <div class="per-unit-metrics" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 2px solid #e2e8f0;">
                                <h3 style="text-align: center; margin: 0 0 20px 0; color: #374151; font-size: 18px; font-weight: 600;">Цена для клиента (за единицу)</h3>
                                <div class="metrics">
                                    <div class="metric-card" style="border: 1px solid #d1d5db;">
                                        <div class="metric-title">Цена продажи</div>
                                        <div class="metric-value" style="font-weight: 800; color: #111827; font-size: 28px;">{{ result.sale_price.per_unit.rub.toLocaleString() }} руб</div>
                                        <div class="metric-secondary">${{ result.sale_price.per_unit.usd }}</div>
                                        <div class="metric-unit" style="color: #6b7280;">За {{ result.quantity.toLocaleString() }} шт: {{ result.sale_price.total.rub.toLocaleString() }} руб</div>
                                    </div>
                                    
                                    <div class="metric-card" style="border: 1px solid #d1d5db;">
                                        <div class="metric-title">Себестоимость</div>
                                        <div class="metric-value" style="font-weight: 700; color: #374151;">{{ result.cost_price.per_unit.rub.toLocaleString() }} руб</div>
                                        <div class="metric-secondary">${{ result.cost_price.per_unit.usd }}</div>
                                        <div class="metric-unit" style="color: #6b7280;">За {{ result.quantity.toLocaleString() }} шт: {{ result.cost_price.total.rub.toLocaleString() }} руб</div>
                                    </div>
                                    
                                    <div class="metric-card" style="border: 1px solid #d1d5db;">
                                        <div class="metric-title">Прибыль</div>
                                        <div class="metric-value" style="font-weight: 700; color: #374151;">{{ result.profit.per_unit.rub.toLocaleString() }} руб</div>
                                        <div class="metric-secondary">${{ result.profit.per_unit.usd }}</div>
                                        <div class="metric-unit" style="color: #6b7280;">За {{ result.quantity.toLocaleString() }} шт: {{ result.profit.total.rub.toLocaleString() }} руб</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Metrics -->
                            <div class="metrics">
                                <div class="metric-card">
                                    <div class="metric-title">Общая стоимость продажи</div>
                                    <div class="metric-value" style="font-weight: 700; color: #1f2937;">{{ result.sale_price.total.rub.toLocaleString() }} руб</div>
                                    <div class="metric-secondary">${{ result.sale_price.total.usd.toLocaleString() }}</div>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="metric-title">Общая себестоимость</div>
                                    <div class="metric-value" style="font-weight: 700; color: #1f2937;">{{ result.cost_price.total.rub.toLocaleString() }} руб</div>
                                    <div class="metric-secondary">${{ result.cost_price.total.usd.toLocaleString() }}</div>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="metric-title">Общая прибыль</div>
                                    <div class="metric-value" style="font-weight: 700; color: #059669;">{{ result.profit.total.rub.toLocaleString() }} руб</div>
                                    <div class="metric-secondary">${{ result.profit.total.usd.toLocaleString() }}</div>
                                </div>
                            </div>
                            
                            <!-- Details -->
                            <div class="details">
                                <div class="detail-group">
                                    <div class="detail-title">Детали товара</div>
                                    <div class="detail-item">
                                        <span class="detail-label">Категория:</span>
                                        <span class="detail-value">{{ result.category }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Тираж:</span>
                                        <span class="detail-value">{{ result.quantity.toLocaleString() }} шт</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Общий вес:</span>
                                        <span class="detail-value">{{ result.estimated_weight }} кг</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Доставка:</span>
                                        <span class="detail-value">{{ result.logistics.delivery_type === 'rail' ? 'Ж/Д' : 'Авиа' }}</span>
                                    </div>
                                </div>
                                
                                <div class="detail-group">
                                    <div class="detail-title">Структура затрат</div>
                                    <div class="detail-item">
                                        <span class="detail-label">Товар:</span>
                                        <span class="detail-value">{{ result.total_price.rub.toLocaleString() }} руб ({{ getPercentOfCost(result.total_price.rub, result.cost_price.total.rub) }}%)</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Логистика:</span>
                                        <span class="detail-value">{{ result.logistics.cost_rub.toLocaleString() }} руб ({{ getPercentOfCost(result.logistics.cost_rub, result.cost_price.total.rub) }}%)</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Локальная доставка:</span>
                                        <span class="detail-value">{{ result.additional_costs.local_delivery_rub.toLocaleString() }} руб ({{ getPercentOfCost(result.additional_costs.local_delivery_rub, result.cost_price.total.rub) }}%)</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Забор МСК:</span>
                                        <span class="detail-value">{{ result.additional_costs.msk_pickup_rub.toLocaleString() }} руб ({{ getPercentOfCost(result.additional_costs.msk_pickup_rub, result.cost_price.total.rub) }}%)</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Прочие расходы:</span>
                                        <span class="detail-value">{{ result.additional_costs.other_costs_rub.toLocaleString() }} руб ({{ getPercentOfCost(result.additional_costs.other_costs_rub, result.cost_price.total.rub) }}%)</span>
                                    </div>
                                    <div class="detail-item" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">
                                        <span class="detail-label"><strong>Наценка:</strong></span>
                                        <span class="detail-value"><strong>{{ ((result.markup - 1) * 100).toFixed(0) }}%</strong></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Product URL -->
                            <div v-if="result.product_url" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                <a :href="result.product_url" target="_blank" 
                                   style="color: #2563eb; text-decoration: none;">
                                    → Открыть страницу товара
                                </a>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
            
            <!-- History Tab -->
            <div v-if="activeTab === 'history'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 class="card-title" style="margin-bottom: 0;">История расчетов</h2>
                            <p class="card-subtitle" style="margin-bottom: 0;">Все ваши расчеты сохранены автоматически</p>
                        </div>
                        <button @click="loadHistory" class="refresh-button">
                            Обновить
                        </button>
                    </div>
                    
                    <!-- Database Status Warning -->
                    <div v-if="!databaseAvailable" class="warning-message" style="background: #fef3cd; border: 1px solid #fde68a; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">⚠️</span>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">База данных недоступна</div>
                            <div style="font-size: 14px;">Калькулятор работает, но история расчетов временно недоступна. Ваши расчеты не сохраняются.</div>
                        </div>
                    </div>
                    
                    <div v-if="history.length === 0 && databaseAvailable" class="empty-state">
                        <div class="empty-icon">📋</div>
                        <h3 style="font-size: 18px; color: #1f2937; margin-bottom: 8px;">Пока нет расчетов</h3>
                        <p style="color: #6b7280; margin-bottom: 16px;">Создайте первый расчет во вкладке "Калькулятор"</p>
                        <button @click="activeTab = 'calculator'" class="nav-button active">
                            Создать расчет
                        </button>
                    </div>
                    
                    <div v-else class="history">
                        <div v-for="item in history" :key="item.id" class="history-item" @click="toggleHistoryDetails(item.id)">
                            <!-- Краткая информация (всегда видна) -->
                            <div class="history-summary">
                                <div class="history-main-info">
                                    <h3>
                                        {{ item.product_name }}
                                        <span class="history-expand-icon" :class="{ expanded: expandedHistory.includes(item.id) }">
                                            ▼
                                        </span>
                                    </h3>
                                    <p>{{ formatDate(item.created_at) }}</p>
                                    <p v-if="item.product_url" style="color: #3b82f6;">
                                        <a :href="item.product_url" target="_blank" @click.stop style="text-decoration: none; color: inherit;">
                                            → Ссылка на товар
                                        </a>
                                    </p>
                                </div>
                                <div class="history-prices">
                                    <div class="history-yuan-price">{{ item.price_yuan }}¥ × {{ item.quantity }}шт</div>
                                    <div class="history-unit-price"><strong>{{ (item.sale_price_rub / item.quantity).toFixed(0) }}</strong> ₽/шт</div>
                                </div>
                            </div>
                            
                            <!-- Детальная информация (раскрывается по клику) -->
                            <div v-if="expandedHistory.includes(item.id)" class="history-details">
                                <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Параметры товара</div>
                                        <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                                            <div><strong>Категория:</strong> {{ item.category }}</div>
                                            <div><strong>Вес:</strong> {{ item.weight_kg }} кг</div>
                                            <div><strong>Количество:</strong> {{ item.quantity }} шт</div>
                                            <div><strong>Наценка:</strong> × {{ item.markup }}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Расчет стоимости</div>
                                        <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                                            <div><strong>Себестоимость общая:</strong> {{ item.cost_price_rub.toFixed(0) }} ₽</div>
                                            <div><strong>Себестоимость за шт:</strong> {{ (item.cost_price_rub / item.quantity).toFixed(0) }} ₽</div>
                                            <div><strong>Цена продажи общая:</strong> <span style="color: #059669; font-weight: 600;">{{ item.sale_price_rub.toFixed(0) }} ₽</span></div>
                                            <div><strong>Прибыль общая:</strong> <span style="color: #dc2626; font-weight: 600;">{{ item.profit_rub.toFixed(0) }} ₽</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    activeTab: 'calculator',
                    isCalculating: false,
                    form: {
                        product_name: '',
                        product_url: '',
                        price_yuan: null,
                        weight_kg: null,
                        quantity: 1,
                        custom_rate: null,
                        delivery_type: 'rail',
                        markup: 1.7
                    },
                    result: null,
                    history: [],
                    expandedHistory: [],
                    detectedCategory: null,
                    categories: [],
                    selectedCategoryIndex: null,
                    databaseAvailable: true
                }
            },
            
            computed: {
                isFormValid() {
                    return this.form.product_name && 
                           this.form.price_yuan > 0 && 
                           this.form.weight_kg > 0 && 
                           this.form.quantity > 0;
                },
                
                suggestedRate() {
                    if (!this.detectedCategory) return 0;
                    const rates = this.detectedCategory.rates;
                    return this.form.delivery_type === 'air' ? rates.air_base : rates.rail_base;
                }
            },
            
            methods: {
                async onProductNameChange() {
                    if (this.form.product_name.length > 2) {
                        try {
                            const response = await axios.get(`/api/category/${encodeURIComponent(this.form.product_name)}`);
                            this.detectedCategory = response.data;
                            
                            // Находим индекс категории
                            this.selectedCategoryIndex = this.categories.findIndex(cat => 
                                cat.category === this.detectedCategory.category
                            );
                            
                            // Автоматически вставляем ставку
                            this.updateSuggestedRate();
                            
                        } catch (error) {
                            console.error('Ошибка определения категории:', error);
                        }
                    }
                },
                
                onCategoryChange() {
                    if (this.selectedCategoryIndex !== null) {
                        this.detectedCategory = this.categories[this.selectedCategoryIndex];
                        this.updateSuggestedRate();
                    }
                },
                
                updateSuggestedRate() {
                    if (this.detectedCategory) {
                        const rates = this.detectedCategory.rates;
                        const suggestedRate = this.form.delivery_type === 'air' ? rates.air_base : rates.rail_base;
                        this.form.custom_rate = suggestedRate;
                    }
                },
                
                async calculatePrice() {
                    if (!this.isFormValid) return;
                    
                    this.isCalculating = true;
                    
                    try {
                        const response = await axios.post('/api/calculate', this.form);
                        this.result = response.data;
                        
                        // Скролл к результатам
                        setTimeout(() => {
                            const resultsEl = document.querySelector('.results');
                            if (resultsEl) {
                                resultsEl.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('Ошибка расчета:', error);
                        alert('Ошибка при расчете. Проверьте введенные данные.');
                    } finally {
                        this.isCalculating = false;
                    }
                },
                
                async loadHistory() {
                    try {
                        const response = await axios.get('/api/history');
                        this.history = response.data.history;
                        this.databaseAvailable = !response.data.error;
                    } catch (error) {
                        console.error('Ошибка загрузки истории:', error);
                        this.databaseAvailable = false;
                        this.history = [];
                    }
                },
                
                async loadCategories() {
                    try {
                        const response = await axios.get('/api/categories');
                        this.categories = response.data;
                    } catch (error) {
                        console.error('Ошибка загрузки категорий:', error);
                    }
                },
                
                async logout() {
                    try {
                        await axios.post('/api/logout');
                        // Перенаправляем на страницу логина
                        window.location.href = '/login';
                    } catch (error) {
                        console.error('Logout error:', error);
                        // В любом случае перенаправляем
                        window.location.href = '/login';
                    }
                },
                
                toggleHistoryDetails(itemId) {
                    const index = this.expandedHistory.indexOf(itemId);
                    if (index > -1) {
                        // Элемент развернут - сворачиваем
                        this.expandedHistory.splice(index, 1);
                    } else {
                        // Элемент свернут - разворачиваем
                        this.expandedHistory.push(itemId);
                    }
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                getCleanCategoryName(categoryName) {
                    // Убираем переносы строк и делаем название более читаемым
                    return categoryName.replace(/\n/g, ' - ').trim();
                },
                
                getPercentOfCost(amount, totalCost) {
                    if (!totalCost || totalCost === 0) return '0';
                    const percent = (amount / totalCost) * 100;
                    return percent.toFixed(1);
                },
                
            },
            
            async mounted() {
                await this.loadCategories();
                await this.loadHistory();
            }
        }).mount('#app');
    </script>
</body>
</html>