# –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

## üéØ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã –¥–ª—è –ª—é–±—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
2. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω - –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Ä—É—á–Ω—É—é
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
4. –ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ü–µ–Ω—ã
5. UX –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º –∏ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –Ω–µ –¥–æ–ª–∂–Ω–∞ –ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
3. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –ø–æ–Ω—è—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞
5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –ø–æ–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–∞–º–∏

---

## üèóÔ∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: "Calculation State Machine" ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (–õ–£–ß–®–ï–ï)

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –ö–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç (FSM) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–∞—Å—á—ë—Ç–∞

**–°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞:**
```
DRAFT ‚Üí PENDING_PARAMS ‚Üí READY ‚Üí CALCULATED ‚Üí SAVED
```

**–î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DRAFT  ‚îÇ (—Ç–æ–≤–∞—Ä –≤–≤–µ–¥—ë–Ω, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ‚Üí (–∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–≤–µ—Å—Ç–Ω–∞) ‚îÄ‚Üí [READY]
     ‚îÇ
     ‚îî‚îÄ‚Üí (–∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) ‚îÄ‚Üí [PENDING_PARAMS]
                                                ‚îÇ
                                                ‚îú‚îÄ‚Üí (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–≤–µ–¥–µ–Ω—ã) ‚îÄ‚Üí [READY]
                                                ‚îÇ
                                                ‚îî‚îÄ‚Üí (–æ—Ç–º–µ–Ω–µ–Ω–æ) ‚îÄ‚Üí [DRAFT]
[READY] ‚îÄ‚Üí (—Ä–∞—Å—á—ë—Ç) ‚îÄ‚Üí [CALCULATED] ‚îÄ‚Üí (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) ‚îÄ‚Üí [SAVED]
```

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

**1. –ú–æ–¥–µ–ª—å Calculation —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:**

```python
# models/calculation_state.py
from enum import Enum
from typing import Optional, Dict, Any

class CalculationState(Enum):
    DRAFT = "draft"                    # –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    PENDING_PARAMS = "pending_params"  # –û–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    READY = "ready"                    # –ì–æ—Ç–æ–≤ –∫ —Ä–∞—Å—á—ë—Ç—É
    CALCULATED = "calculated"          # –†–∞—Å—Å—á–∏—Ç–∞–Ω
    SAVED = "saved"                    # –°–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î

class CalculationStateMachine:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏"""
    
    TRANSITIONS = {
        CalculationState.DRAFT: [
            CalculationState.PENDING_PARAMS,
            CalculationState.READY
        ],
        CalculationState.PENDING_PARAMS: [
            CalculationState.READY,
            CalculationState.DRAFT
        ],
        CalculationState.READY: [
            CalculationState.CALCULATED
        ],
        CalculationState.CALCULATED: [
            CalculationState.SAVED,
            CalculationState.DRAFT  # –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        ],
        CalculationState.SAVED: [
            CalculationState.DRAFT  # –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        ]
    }
    
    def __init__(self, initial_state: CalculationState = CalculationState.DRAFT):
        self.state = initial_state
        self.history = [initial_state]
    
    def can_transition_to(self, target_state: CalculationState) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞"""
        return target_state in self.TRANSITIONS.get(self.state, [])
    
    def transition_to(self, target_state: CalculationState, context: Dict[str, Any] = None):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –≤ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"""
        if not self.can_transition_to(target_state):
            raise ValueError(
                f"Invalid transition: {self.state.value} ‚Üí {target_state.value}"
            )
        
        self.state = target_state
        self.history.append(target_state)
        
        # –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞
        self._on_enter_state(target_state, context)
    
    def _on_enter_state(self, state: CalculationState, context: Dict[str, Any] = None):
        """–•—É–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"""
        handlers = {
            CalculationState.PENDING_PARAMS: self._handle_pending_params,
            CalculationState.READY: self._handle_ready,
            CalculationState.CALCULATED: self._handle_calculated,
        }
        
        handler = handlers.get(state)
        if handler:
            handler(context or {})
    
    def _handle_pending_params(self, context: Dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
        print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {context.get('category')}")
    
    def _handle_ready(self, context: Dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–∞—Å—á—ë—Ç—É"""
        print(f"‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞—Å—á—ë—Ç—É")
    
    def _handle_calculated(self, context: Dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞"""
        print(f"üí∞ –†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: {context.get('cost_price')} ‚ÇΩ")
```

**2. –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:**

```python
# models/category.py
from dataclasses import dataclass, field
from typing import List, Optional, Dict

@dataclass
class CategoryRequirements:
    """–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º"""
    requires_logistics_rate: bool = False
    requires_duty_rate: bool = False
    requires_vat_rate: bool = False
    requires_specific_rate: bool = False
    
    def is_complete(self, provided_params: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –ª–∏ —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã"""
        checks = []
        
        if self.requires_logistics_rate:
            checks.append('custom_rate' in provided_params)
        if self.requires_duty_rate:
            checks.append('duty_rate' in provided_params)
        if self.requires_vat_rate:
            checks.append('vat_rate' in provided_params)
        if self.requires_specific_rate:
            checks.append('specific_rate' in provided_params)
        
        return all(checks)

@dataclass
class Category:
    """–ú–æ–¥–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞"""
    id: int
    name: str
    material: str = ""
    
    # –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ (–º–æ–≥—É—Ç –±—ã—Ç—å None)
    rail_base: Optional[float] = None
    air_base: Optional[float] = None
    
    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    requirements: CategoryRequirements = field(default_factory=CategoryRequirements)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    keywords: List[str] = field(default_factory=list)
    description: str = ""
    
    def needs_custom_params(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω—É–∂–Ω—ã –ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        # –ï—Å–ª–∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
        if self.rail_base is None or self.rail_base == 0:
            return True
        if self.air_base is None or self.air_base == 0:
            return True
        
        # –ò–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
        return (self.requirements.requires_logistics_rate or
                self.requirements.requires_duty_rate or
                self.requirements.requires_vat_rate or
                self.requirements.requires_specific_rate)
    
    def validate_params(self, params: Dict) -> tuple[bool, List[str]]:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        errors = []
        
        if self.requirements.requires_logistics_rate and 'custom_rate' not in params:
            errors.append("–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–≤–∫–∞")
        
        if self.requirements.requires_duty_rate and 'duty_rate' not in params:
            errors.append("–¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç–∞–≤–∫–∞ –ø–æ—à–ª–∏–Ω—ã")
        
        return len(errors) == 0, errors
```

**3. –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞–º–∏:**

```python
# services/calculation_manager.py
class CalculationManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ä–∞—Å—á—ë—Ç–∞"""
    
    def __init__(self, calculator: PriceCalculator, db):
        self.calculator = calculator
        self.db = db
    
    def create_calculation(self, product_name: str, **params) -> Dict:
        """–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç"""
        # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        category = self.calculator.find_category_by_name(product_name)
        
        # 2. –°–æ–∑–¥–∞—ë–º state machine
        state_machine = CalculationStateMachine()
        
        # 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if category.needs_custom_params():
            state_machine.transition_to(
                CalculationState.PENDING_PARAMS,
                context={'category': category.name}
            )
        else:
            state_machine.transition_to(CalculationState.READY)
        
        return {
            'id': None,
            'state': state_machine.state.value,
            'category': category,
            'params': params,
            'custom_logistics': {},
            'result': None
        }
    
    def provide_custom_params(self, calculation: Dict, custom_logistics: Dict) -> Dict:
        """–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        state_machine = CalculationStateMachine(
            CalculationState(calculation['state'])
        )
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        category = calculation['category']
        is_valid, errors = category.validate_params(custom_logistics)
        
        if not is_valid:
            return {
                'success': False,
                'errors': errors
            }
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á—ë—Ç
        calculation['custom_logistics'] = custom_logistics
        state_machine.transition_to(CalculationState.READY)
        calculation['state'] = state_machine.state.value
        
        return {
            'success': True,
            'calculation': calculation
        }
    
    def perform_calculation(self, calculation: Dict) -> Dict:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—á—ë—Ç"""
        state_machine = CalculationStateMachine(
            CalculationState(calculation['state'])
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–∂–µ–º —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å
        if state_machine.state != CalculationState.READY:
            raise ValueError(f"Cannot calculate in state: {state_machine.state.value}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á—ë—Ç
        result = self.calculator.calculate_cost(
            **calculation['params'],
            custom_logistics_params=calculation['custom_logistics']
        )
        
        calculation['result'] = result
        state_machine.transition_to(
            CalculationState.CALCULATED,
            context={'cost_price': result.get('cost_price', {}).get('total', {}).get('rub')}
        )
        calculation['state'] = state_machine.state.value
        
        return calculation
    
    def save_calculation(self, calculation: Dict) -> int:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞—Å—á—ë—Ç –≤ –ë–î"""
        state_machine = CalculationStateMachine(
            CalculationState(calculation['state'])
        )
        
        if state_machine.state != CalculationState.CALCULATED:
            raise ValueError("Can only save CALCULATED calculations")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        calc_id = self.db.save_calculation(calculation)
        
        state_machine.transition_to(CalculationState.SAVED)
        calculation['state'] = state_machine.state.value
        calculation['id'] = calc_id
        
        return calc_id
```

**4. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:**

```javascript
// composables/useCalculationState.js
import { ref, computed, watch } from 'vue';

export function useCalculationState(initialState = 'draft') {
    const state = ref(initialState);
    const history = ref([initialState]);
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
    const transitions = {
        draft: ['pending_params', 'ready'],
        pending_params: ['ready', 'draft'],
        ready: ['calculated'],
        calculated: ['saved', 'draft'],
        saved: ['draft']
    };
    
    // Computed —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
    const isDraft = computed(() => state.value === 'draft');
    const isPendingParams = computed(() => state.value === 'pending_params');
    const isReady = computed(() => state.value === 'ready');
    const isCalculated = computed(() => state.value === 'calculated');
    const isSaved = computed(() => state.value === 'saved');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞
    const canTransitionTo = (targetState) => {
        const allowed = transitions[state.value] || [];
        return allowed.includes(targetState);
    };
    
    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const transitionTo = (targetState, context = {}) => {
        if (!canTransitionTo(targetState)) {
            console.error(`Invalid transition: ${state.value} ‚Üí ${targetState}`);
            return false;
        }
        
        state.value = targetState;
        history.value.push(targetState);
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫–∏
        onEnterState(targetState, context);
        
        return true;
    };
    
    // –•—É–∫–∏ –≤—Ö–æ–¥–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const onEnterState = (newState, context) => {
        const handlers = {
            pending_params: () => {
                console.log('‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤');
                // –ú–æ–∂–Ω–æ —ç–º–∏—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–ª—è UI
            },
            ready: () => {
                console.log('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞—Å—á—ë—Ç—É');
            },
            calculated: () => {
                console.log('üí∞ –†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
            }
        };
        
        const handler = handlers[newState];
        if (handler) handler(context);
    };
    
    return {
        state,
        history,
        isDraft,
        isPendingParams,
        isReady,
        isCalculated,
        isSaved,
        canTransitionTo,
        transitionTo
    };
}
```

```vue
<!-- PriceCalculatorAppV2.vue -->
<script setup>
import { useCalculationState } from './composables/useCalculationState';

const calculationState = useCalculationState();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
watch(() => calculationState.isPendingParams.value, (isPending) => {
    if (isPending) {
        // –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        showParamsModal.value = true;
    }
});

const handleCategoryDetected = (category) => {
    if (category.needs_custom_params) {
        calculationState.transitionTo('pending_params', { category });
    } else {
        calculationState.transitionTo('ready');
    }
};

const handleParamsProvided = (customParams) => {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    customLogistics.value = customParams;
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ ready
    calculationState.transitionTo('ready');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á—ë—Ç
    performCalculation();
};

const performCalculation = async () => {
    const result = await axios.post('/api/v2/calculate', {
        ...formData.value,
        custom_logistics: customLogistics.value,
        state: calculationState.state.value
    });
    
    calculationState.transitionTo('calculated', { 
        cost_price: result.data.cost_price 
    });
};
</script>

<template>
    <!-- UI –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div class="calculator">
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
        <StateIndicator :state="calculationState.state.value" />
        
        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞) -->
        <ProductForm 
            v-model="formData"
            :disabled="!calculationState.isDraft"
        />
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
        <CustomParamsModal
            v-if="calculationState.isPendingParams"
            :category="currentCategory"
            @submit="handleParamsProvided"
            @cancel="calculationState.transitionTo('draft')"
        />
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–∞) -->
        <CalculationResults
            v-if="calculationState.isCalculated || calculationState.isSaved"
            :result="calculationResult"
        />
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ) -->
        <div class="actions">
            <button 
                v-if="calculationState.isReady"
                @click="performCalculation"
            >
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
            </button>
            
            <button
                v-if="calculationState.isCalculated"
                @click="saveCalculation"
            >
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            
            <button
                v-if="calculationState.isSaved"
                @click="calculationState.transitionTo('draft')"
            >
                –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç
            </button>
        </div>
    </div>
</template>
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ State Machine:

‚úÖ **–Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** - –≤—Å–µ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–æ –≤ –∫–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–∞—Å—á—ë—Ç  
‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π** - FSM –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å  
‚úÖ **–õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** - —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è  
‚úÖ **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è** - –º–æ–∂–Ω–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É —Å–æ—Å—Ç–æ—è–Ω–∏–π  
‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏  
‚úÖ **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:

‚ùå –¢—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞  
‚ùå –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è  
‚ùå –ù—É–∂–Ω–æ –æ–±—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –ø–∞—Ç—Ç–µ—Ä–Ω—É FSM  

---

### –†–µ—à–µ–Ω–∏–µ 2: "Calculation Context with Strategy Pattern" ‚≠ê‚≠ê‚≠ê‚≠ê

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞—Å—á—ë—Ç–∞ + —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```python
# models/calculation_context.py
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class CalculationStrategy(ABC):
    """–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞—Å—á—ë—Ç–∞"""
    
    @abstractmethod
    def requires_user_input(self, category: Category) -> bool:
        """–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        pass
    
    @abstractmethod
    def get_required_params(self, category: Category) -> List[str]:
        """–ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–µ–±—É—é—Ç—Å—è"""
        pass
    
    @abstractmethod
    def calculate(self, context: 'CalculationContext') -> Dict[str, Any]:
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç"""
        pass

class StandardCategoryStrategy(CalculationStrategy):
    """–°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
    
    def requires_user_input(self, category: Category) -> bool:
        return False
    
    def get_required_params(self, category: Category) -> List[str]:
        return []
    
    def calculate(self, context: 'CalculationContext') -> Dict[str, Any]:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        return context.calculator.calculate_cost(
            **context.params,
            category=context.category
        )

class CustomCategoryStrategy(CalculationStrategy):
    """–°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
    
    def requires_user_input(self, category: Category) -> bool:
        return not category.rail_base or not category.air_base
    
    def get_required_params(self, category: Category) -> List[str]:
        params = []
        if not category.rail_base:
            params.append('rail_rate')
        if not category.air_base:
            params.append('air_rate')
        return params
    
    def calculate(self, context: 'CalculationContext') -> Dict[str, Any]:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        return context.calculator.calculate_cost(
            **context.params,
            custom_logistics_params=context.custom_logistics
        )

class CalculationContext:
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞—Å—á—ë—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
    
    def __init__(self, calculator: PriceCalculator):
        self.calculator = calculator
        self.category: Optional[Category] = None
        self.params: Dict[str, Any] = {}
        self.custom_logistics: Dict[str, Any] = {}
        self.strategy: Optional[CalculationStrategy] = None
        self.result: Optional[Dict[str, Any]] = None
    
    def set_product(self, product_name: str, **params):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é"""
        self.category = self.calculator.find_category_by_name(product_name)
        self.params = params
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if self.category.needs_custom_params():
            self.strategy = CustomCategoryStrategy()
        else:
            self.strategy = StandardCategoryStrategy()
    
    def needs_user_input(self) -> bool:
        """–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if not self.strategy:
            return False
        return self.strategy.requires_user_input(self.category)
    
    def get_required_params(self) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±—É–µ–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
        if not self.strategy:
            return []
        return self.strategy.get_required_params(self.category)
    
    def provide_custom_logistics(self, custom_logistics: Dict[str, Any]):
        """–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        self.custom_logistics = custom_logistics
    
    def calculate(self) -> Dict[str, Any]:
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é"""
        if not self.strategy:
            raise ValueError("Strategy not set. Call set_product first.")
        
        self.result = self.strategy.calculate(self)
        return self.result
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Strategy Pattern:

‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏  
‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞  
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏  
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π = –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏  

---

### –†–µ—à–µ–Ω–∏–µ 3: "Event-Driven Architecture" ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –°–æ–±—ã—Ç–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º

```python
# events/calculation_events.py
from dataclasses import dataclass
from typing import Any, Dict
from datetime import datetime

@dataclass
class CalculationEvent:
    """–ë–∞–∑–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Ä–∞—Å—á—ë—Ç–∞"""
    calculation_id: str
    timestamp: datetime
    data: Dict[str, Any]

@dataclass
class CategoryDetectedEvent(CalculationEvent):
    """–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞"""
    category_name: str
    needs_custom_params: bool

@dataclass
class CustomParamsRequestedEvent(CalculationEvent):
    """–ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
    required_params: list

@dataclass
class CustomParamsProvidedEvent(CalculationEvent):
    """–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã"""
    custom_logistics: Dict

@dataclass
class CalculationCompletedEvent(CalculationEvent):
    """–†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω"""
    result: Dict

# Event Bus
class EventBus:
    """–®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π"""
    
    def __init__(self):
        self._handlers = {}
    
    def subscribe(self, event_type: type, handler: callable):
        """–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ"""
        if event_type not in self._handlers:
            self._handlers[event_type] = []
        self._handlers[event_type].append(handler)
    
    def publish(self, event: CalculationEvent):
        """–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ"""
        event_type = type(event)
        handlers = self._handlers.get(event_type, [])
        
        for handler in handlers:
            try:
                handler(event)
            except Exception as e:
                print(f"Error in event handler: {e}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
class CalculationEventHandlers:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ä–∞—Å—á—ë—Ç–∞"""
    
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self._register_handlers()
    
    def _register_handlers(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
        self.event_bus.subscribe(CategoryDetectedEvent, self.on_category_detected)
        self.event_bus.subscribe(CustomParamsProvidedEvent, self.on_params_provided)
        self.event_bus.subscribe(CalculationCompletedEvent, self.on_calculation_completed)
    
    def on_category_detected(self, event: CategoryDetectedEvent):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        if event.needs_custom_params:
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            self.event_bus.publish(CustomParamsRequestedEvent(
                calculation_id=event.calculation_id,
                timestamp=datetime.now(),
                data={},
                required_params=['custom_rate', 'duty_rate']
            ))
    
    def on_params_provided(self, event: CustomParamsProvidedEvent):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
        print(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ {event.calculation_id}")
        # –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—á—ë—Ç
    
    def on_calculation_completed(self, event: CalculationCompletedEvent):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞"""
        print(f"–†–∞—Å—á—ë—Ç {event.calculation_id} –∑–∞–≤–µ—Ä—à—ë–Ω")
        # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∏ —Ç.–¥.
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Event-Driven:

‚úÖ **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ –∑–Ω–∞—é—Ç –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏  
‚úÖ **–ê—É–¥–∏—Ç** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π  
‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - —Å–æ–±—ã—Ç–∏—è –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ  
‚úÖ **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã  

---

### –†–µ—à–µ–Ω–∏–µ 4: "Builder Pattern –¥–ª—è Calculation" ‚≠ê‚≠ê‚≠ê

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –ü–æ—à–∞–≥–æ–≤–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞

```python
class CalculationBuilder:
    """–°—Ç—Ä–æ–∏—Ç–µ–ª—å —Ä–∞—Å—á—ë—Ç–∞"""
    
    def __init__(self, calculator: PriceCalculator):
        self.calculator = calculator
        self._product_name = None
        self._category = None
        self._params = {}
        self._custom_logistics = {}
        self._validation_errors = []
    
    def with_product(self, product_name: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"""
        self._product_name = product_name
        self._category = self.calculator.find_category_by_name(product_name)
        return self
    
    def with_params(self, **params):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        self._params = params
        return self
    
    def with_custom_logistics(self, custom_logistics: Dict):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏"""
        self._custom_logistics = custom_logistics
        return self
    
    def validate(self) -> bool:
        """–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º"""
        self._validation_errors = []
        
        if not self._product_name:
            self._validation_errors.append("Product name is required")
        
        if self._category and self._category.needs_custom_params():
            if not self._custom_logistics:
                self._validation_errors.append("Custom logistics required for this category")
        
        return len(self._validation_errors) == 0
    
    def build(self) -> Dict[str, Any]:
        """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å—á—ë—Ç"""
        if not self.validate():
            raise ValueError(f"Validation failed: {self._validation_errors}")
        
        result = self.calculator.calculate_cost(
            **self._params,
            custom_logistics_params=self._custom_logistics,
            forced_category=self._category.name if self._category else None
        )
        
        return {
            'product_name': self._product_name,
            'category': self._category,
            'params': self._params,
            'custom_logistics': self._custom_logistics,
            'result': result,
            'is_custom': bool(self._custom_logistics)
        }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
calculation = (CalculationBuilder(calculator)
    .with_product("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä")
    .with_params(quantity=100, weight_kg=0.5, unit_price_yuan=50)
    .with_custom_logistics({"highway_rail": {"custom_rate": 8.5}})
    .build())
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π

| –ö—Ä–∏—Ç–µ—Ä–∏–π | State Machine | Strategy | Event-Driven | Builder |
|----------|--------------|----------|--------------|---------|
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê |
| **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **–û—Ç–ª–∞–¥–∫–∞** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è** | 2-3 –¥–Ω—è | 1-2 –¥–Ω—è | 3-4 –¥–Ω—è | 1 –¥–µ–Ω—å |

---

## üèÜ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

### –ì–∏–±—Ä–∏–¥–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: **State Machine + Strategy Pattern**

–ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –ª—É—á—à–µ–µ –∏–∑ –æ–±–æ–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤:

**State Machine** - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º  
**Strategy Pattern** - –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞—Å—á—ë—Ç–æ–≤

```python
class CalculationOrchestrator:
    """–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—á—ë—Ç–æ–≤"""
    
    def __init__(self, calculator: PriceCalculator):
        self.calculator = calculator
        self.state_machine = CalculationStateMachine()
        self.context = CalculationContext(calculator)
    
    def process_calculation(self, product_name: str, **params):
        """–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á—ë—Ç–∞"""
        # 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–≤–∞—Ä –∏ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        self.context.set_product(product_name, **params)
        
        # 2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω—É–∂–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if self.context.needs_user_input():
            self.state_machine.transition_to(CalculationState.PENDING_PARAMS)
            return {
                'state': 'pending_params',
                'required_params': self.context.get_required_params()
            }
        else:
            self.state_machine.transition_to(CalculationState.READY)
        
        # 3. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á—ë—Ç
        result = self.context.calculate()
        self.state_machine.transition_to(CalculationState.CALCULATED)
        
        return {
            'state': 'calculated',
            'result': result
        }
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ:

‚úÖ **–Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** (State Machine)  
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤** (Strategy Pattern)  
‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è  
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å FSM –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ  
‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π  
‚úÖ **–ù–µ —Å–ª–æ–º–∞–µ—Ç—Å—è** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π  

---

## üìù –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1 –¥–µ–Ω—å)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ (Category, CategoryRequirements)
- [ ] –°–æ–∑–¥–∞—Ç—å CalculationState enum
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –§–∞–∑–∞ 2: –ë—ç–∫–µ–Ω–¥ (2 –¥–Ω—è)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CalculationStateMachine
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CalculationStrategy (–±–∞–∑–æ–≤—ã–π + –∫–∞—Å—Ç–æ–º–Ω—ã–π)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CalculationContext
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CalculationOrchestrator
- [ ] –û–±–Ω–æ–≤–∏—Ç—å API endpoints
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –§–∞–∑–∞ 3: –§—Ä–æ–Ω—Ç–µ–Ω–¥ (2 –¥–Ω—è)
- [ ] –°–æ–∑–¥–∞—Ç—å composable useCalculationState
- [ ] –û–±–Ω–æ–≤–∏—Ç—å PriceCalculatorAppV2
- [ ] –û–±–Ω–æ–≤–∏—Ç—å RouteEditorV2 (—É–±—Ä–∞—Ç—å isNewCategory –ª–æ–≥–∏–∫—É)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å HistoryPanelV2
- [ ] –î–æ–±–∞–≤–∏—Ç—å StateIndicator –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 –¥–µ–Ω—å)
- [ ] E2E —Ç–µ—Å—Ç—ã –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 6 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π –≤–µ—Ä–¥–∏–∫—Ç

**State Machine + Strategy Pattern** - —ç—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ, enterprise-level —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ:

1. **–ù–µ —Å–ª–æ–º–∞–µ—Ç—Å—è** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
2. **–õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è** - –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ = –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
3. **–Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –≤—Å–µ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
4. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ** - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º–æ** - –¥–∏–∞–≥—Ä–∞–º–º—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π + UML

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫—Ä—É–ø–Ω—ã—Ö enterprise —Å–∏—Å—Ç–µ–º–∞—Ö (—Ñ–∏–Ω—Ç–µ—Ö, e-commerce) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã–º–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.





