# V3 API - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –î–∞—Ç–∞: 13.10.2025

---

## üß™ –¢–ï–°–¢–´ V3 API

### ‚úÖ –¢–ï–°–¢ 1: –°—Ç–∞—Ç—É—Å V3 API
```bash
GET /api/v3/status
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –û–ö**
```json
{
    "v3_loaded": true,
    "error": null,
    "available_routes": [
        "/api/v3/factories",
        "/api/v3/positions",
        "/api/v3/calculations"
    ]
}
```

---

### ‚úÖ –¢–ï–°–¢ 2: –†–∞—Å—á—ë—Ç –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
```bash
POST /api/v3/calculate/execute
{
  "product_name": "–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞",
  "price_yuan": 50,
  "quantity": 1000,
  "weight_kg": 0.2,
  "markup": 1.7
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –û–ö (–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)**
```json
{
  "category": "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
  "needs_custom_params": true,
  "message": "–î–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏",
  "routes": {
    "highway_rail": { "placeholder": true, "needs_params": true },
    "highway_air": { "placeholder": true, "needs_params": true },
    "highway_contract": { "placeholder": true, "needs_params": true }
  }
}
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è placeholder –º–∞—Ä—à—Ä—É—Ç—ã

---

### ‚úÖ –¢–ï–°–¢ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
```bash
GET /api/v3/categories
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –û–ö**
```json
{
  "total": 105,
  "version": "3.0",
  "source": "PostgreSQL (Railway)",
  "categories": [
    {
      "category": "–ê–≤–æ—Å—å–∫–∏",
      "material": "–∞–∫—Ä–∏–ª",
      "duty_rate": "15%",
      "vat_rate": "20%",
      "tnved_code": "5608900000",
      "rates": { "air_base": 6.5, "rail_base": 4.4 }
    },
    ...
  ]
}
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –ó–∞–≥—Ä—É–∂–µ–Ω–æ 105 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ PostgreSQL

---

### ‚úÖ –¢–ï–°–¢ 4: –†–∞—Å—á—ë—Ç —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
```bash
POST /api/v3/calculate/execute
{
  "product_name": "–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞",
  "forced_category": "—Ñ—É—Ç–±–æ–ª–∫–∞",
  "price_yuan": 50,
  "quantity": 1000,
  "weight_kg": 0.2,
  "markup": 1.7
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –û–ö**
```
category: —Ñ—É—Ç–±–æ–ª–∫–∞
needs_custom_params: False
routes: 3 –º–∞—Ä—à—Ä—É—Ç–æ–≤
  highway_rail: 895.88‚ÇΩ/—à—Ç, placeholder=False
  highway_air: 931.16‚ÇΩ/—à—Ç, placeholder=False
  highway_contract: 923.99‚ÇΩ/—à—Ç, placeholder=False
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏

---

### ‚ùå –¢–ï–°–¢ 5: –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å —É–ø–∞–∫–æ–≤–∫–æ–π
```bash
POST /api/v3/calculate/execute
{
  "product_name": "–§—É—Ç–±–æ–ª–∫–∞ —Å —É–ø–∞–∫–æ–≤–∫–æ–π",
  "forced_category": "—Ñ—É—Ç–±–æ–ª–∫–∞",
  "price_yuan": 50,
  "quantity": 1000,
  "markup": 1.7,
  "is_precise_calculation": true,
  "packing_units_per_box": 50,
  "packing_box_weight": 10,
  "packing_box_length": 0.6,
  "packing_box_width": 0.4,
  "packing_box_height": 0.3
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå –û–®–ò–ë–ö–ê 422**
```json
{
  "detail": [
    {
      "type": "missing",
      "loc": ["body", "weight_kg"],
      "msg": "Field required"
    },
    {
      "type": "value_error",
      "loc": ["body", "packing_units_per_box"],
      "msg": "–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ç—Ä–µ–±—É—é—Ç—Å—è –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø–∞–∫–æ–≤–∫–∏"
    }
  ]
}
```

‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** Pydantic —Å—Ö–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç `weight_kg` –¥–∞–∂–µ –ø—Ä–∏ `is_precise_calculation=true`

---

## üìä –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

| –¢–µ—Å—Ç | Endpoint | –°—Ç–∞—Ç—É—Å | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|------|----------|--------|-----------|
| 1 | `/api/v3/status` | ‚úÖ | V3 API –∑–∞–≥—Ä—É–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| 2 | `/api/v3/calculate/execute` (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) | ‚úÖ | Placeholder –º–∞—Ä—à—Ä—É—Ç—ã |
| 3 | `/api/v3/categories` | ‚úÖ | 105 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î |
| 4 | `/api/v3/calculate/execute` (—Ñ—É—Ç–±–æ–ª–∫–∞) | ‚úÖ | –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã: 895-931‚ÇΩ/—à—Ç |
| 5 | `/api/v3/calculate/execute` (–¥–µ—Ç–∞–ª—å–Ω—ã–π) | ‚ùå | –û—à–∏–±–∫–∞ —Å—Ö–µ–º—ã |

**–°—Ç–∞—Ç—É—Å:** 4/5 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ (80%)

---

## üêõ –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞ #1: weight_kg –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–º —Ä–∞—Å—á—ë—Ç–µ

**–§–∞–π–ª:** `schemas/calculation_schemas.py` –∏–ª–∏ `main.py`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ `is_precise_calculation=true` –ø–æ–ª–µ `weight_kg` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `Optional`
- –í–µ—Å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: `weight_kg = packing_box_weight / packing_units_per_box`
- –ù–æ Pydantic —Å—Ö–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç `weight_kg` –≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
class CalculationRequest(BaseModel):
    weight_kg: Optional[float] = None  # ‚Üê –°–¥–µ–ª–∞—Ç—å optional
    
    @model_validator(mode='after')
    def validate_calculation_mode(self):
        if self.is_precise_calculation:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–ª—è —É–ø–∞–∫–æ–≤–∫–∏
            if not all([
                self.packing_units_per_box,
                self.packing_box_weight,
                self.packing_box_length,
                self.packing_box_width,
                self.packing_box_height
            ]):
                raise ValueError("–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ç—Ä–µ–±—É—é—Ç—Å—è –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø–∞–∫–æ–≤–∫–∏")
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ—Å –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
            if not self.weight_kg:
                self.weight_kg = self.packing_box_weight / self.packing_units_per_box
        else:
            # –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∂–∏–º–∞ weight_kg –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            if not self.weight_kg:
                raise ValueError("–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –≤–µ—Å –µ–¥–∏–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞")
        
        return self
```

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û

### 1. V3 API Architecture
- ‚úÖ State Machine –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ Placeholder –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

### 2. PostgreSQL Integration
- ‚úÖ 105 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (rates, duty_rate, vat_rate) –¥–æ—Å—Ç—É–ø–Ω—ã

### 3. API Response Format
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å routes, logistics, customs
- ‚úÖ –§–ª–∞–≥–∏ `needs_custom_params`, `placeholder` —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï V3 UI

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ)

**URL:** https://price-calculator-production.up.railway.app/v3

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á—ë—Ç (–ø–æ –≤–µ—Å—É)**
1. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ /v3
2. ‚úÖ –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞"
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è: "—Ñ—É—Ç–±–æ–ª–∫–∞" (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
   - –¶–µ–Ω–∞: 50¬•
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1000
   - –í–µ—Å: 0.2 –∫–≥
   - –ù–∞—Ü–µ–Ω–∫–∞: 1.7
3. ‚úÖ –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –ñ–î, –ê–≤–∏–∞, –ö–æ–Ω—Ç—Ä–∞–∫—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- 3 –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Ü–µ–Ω–∞–º–∏ ~895-931‚ÇΩ/—à—Ç

---

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç (—É–ø–∞–∫–æ–≤–∫–∞)**
1. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ /v3
2. ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –Ω–∞ "–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç"
3. ‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É (50—à—Ç, 10–∫–≥, 0.6x0.4x0.3–º)
4. ‚ùå –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"

**–¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ùå –û—à–∏–±–∫–∞ 422 (weight_kg required)
**–û–∂–∏–¥–∞–µ–º—ã–π –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:** ‚úÖ –†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –≤–µ—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ö–µ–º—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞**
   - –°–¥–µ–ª–∞—Ç—å `weight_kg` optional
   - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–µ—Å–∞ –∏–∑ —É–ø–∞–∫–æ–≤–∫–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UI –≤—Ä—É—á–Ω—É—é**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ (–≤–µ—Å/—É–ø–∞–∫–æ–≤–∫–∞)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏—è)
3. **–î–æ–±–∞–≤–∏—Ç—å integration —Ç–µ—Å—Ç—ã**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI
   - E2E —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢

**V3 API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 80%:**

‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- V3 API —Ä–æ—É—Ç–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- –†–∞—Å—á—ë—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (895-931‚ÇΩ/—à—Ç –¥–ª—è —Ñ—É—Ç–±–æ–ª–∫–∏)
- Placeholder –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- PostgreSQL —Å 105 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏

‚ùå **–ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å —É–ø–∞–∫–æ–≤–∫–æ–π (–æ—à–∏–±–∫–∞ —Å—Ö–µ–º—ã)

üîß **–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å Pydantic —Å—Ö–µ–º—É –¥–ª—è `weight_kg`
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å V3 UI –≤ –±—Ä–∞—É–∑–µ—Ä–µ

**–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** ~15 –º–∏–Ω—É—Ç  
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è

