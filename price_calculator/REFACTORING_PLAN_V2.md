# üöÄ –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê V2.0 (—Å "–ù–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π" –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 10.10.2025  
**–°—Ç–∞—Ç—É—Å:** –ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥, —É–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, —É–ª—É—á—à–∏—Ç—å —Ä–∞–±–æ—Ç—É "–ù–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"

---

## üéØ –ì–õ–ê–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### 1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î**

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```python
# –í –ë–î —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ ONE custom_rate (legacy –ø–æ–ª–µ –¥–ª—è Highway)
custom_rate REAL  # –¢–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

# –ù–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ú–ê–†–®–†–£–¢–ê:
custom_logistics = {
    "highway_rail": {"custom_rate": 4, "duty_rate": 10, "vat_rate": 20},
    "prologix": {"custom_rate": 25000, "duty_rate": 10, "vat_rate": 20},
    "sea_container": {"duty_rate": 15, "vat_rate": 20}
}

# –ò forced_category —Ç–æ–∂–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!
forced_category = "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¢–ï–†–Ø–Æ–¢–°–Ø
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç —Å "–ù–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π"
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥—É–º–∞–µ—Ç —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ –æ–Ω–∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

### 2. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –¢–æ–≤–∞—Ä "XYZ" ‚Üí "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" ‚Üí –í–≤–æ–¥ —Å—Ç–∞–≤–æ–∫ ‚Üí –†–∞—Å—Å—á–∏—Ç–∞–ª
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î: category="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è", –Ω–æ –ë–ï–ó –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –û–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Üí –û—Ç–∫—Ä—ã–ª —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å rail_base=0, custom_logistics=null ‚Üí –¶–∏—Ñ—Ä—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï
```

**–¢–µ–∫—É—â–∏–π –∫–æ—Å—Ç—ã–ª—å:**
- Frontend —Ö—Ä–∞–Ω–∏—Ç `customLogistics` –≤ –ø–∞–º—è—Ç–∏
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí –ø–∞–º—è—Ç—å –æ—á–∏—â–∞–µ—Ç—Å—è ‚Üí –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è

---

### 3. **–í–´–°–û–ö–ê–Ø: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—ã–∑–æ–≤–∞ `calculate_cost()`**

(–£–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∞–Ω–∞–ª–∏–∑–µ - –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–º)

---

### 4. **–°–†–ï–î–ù–Ø–Ø: –ù–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª —Ä–∞—Å—á—ë—Ç #238 —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª ‚Üí PUT /calculation/238 ‚Üí –ó–∞–ø–∏—Å—å –ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–ê
3. –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí –Ω–µ–ª—å–∑—è –æ—Ç–∫–∞—Ç–∏—Ç—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
```

---

## üí° –†–ï–®–ï–ù–ò–Ø

### –≠—Ç–∞–ø 0: –§–£–ù–î–ê–ú–ï–ù–¢ - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –∏ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (2-3 –¥–Ω—è)

#### 0.1 **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –ë–î –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

**SQL –º–∏–≥—Ä–∞—Ü–∏—è:**
```sql
-- –î–æ–±–∞–≤–ª—è–µ–º JSONB –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
ALTER TABLE calculations 
ADD COLUMN custom_logistics JSONB DEFAULT NULL;

-- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
ALTER TABLE calculations 
ADD COLUMN forced_category TEXT DEFAULT NULL;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
CREATE INDEX idx_calculations_forced_category 
ON calculations(forced_category);

-- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç–∞–±–ª–∏—Ü–∞ –≤–µ—Ä—Å–∏–π –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
CREATE TABLE calculation_versions (
    id SERIAL PRIMARY KEY,
    calculation_id INTEGER NOT NULL REFERENCES calculations(id),
    version INTEGER NOT NULL,
    custom_logistics JSONB,
    forced_category TEXT,
    cost_price_rub REAL,
    cost_price_usd REAL,
    sale_price_rub REAL,
    sale_price_usd REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(calculation_id, version)
);
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π Pydantic:**
```python
# models/calculation.py
from pydantic import BaseModel, Field, validator, root_validator
from typing import Optional, Dict, Literal
from datetime import datetime

class CustomLogisticsParams(BaseModel):
    """–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞"""
    custom_rate: Optional[float] = Field(None, ge=0, description="–ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–≤–∫–∞")
    duty_rate: Optional[float] = Field(None, ge=0, le=100, description="–ü–æ—à–ª–∏–Ω–∞ (%)")
    vat_rate: Optional[float] = Field(None, ge=0, le=100, description="–ù–î–° (%)")
    duty_type: Literal["percent", "specific", "combined"] = "percent"
    specific_rate: Optional[float] = Field(None, ge=0, description="–í–µ—Å–æ–≤–∞—è –ø–æ—à–ª–∏–Ω–∞ (EUR/–∫–≥)")
    
    @root_validator
    def validate_duty_consistency(cls, values):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ duty_type –∏ specific_rate"""
        duty_type = values.get('duty_type')
        specific_rate = values.get('specific_rate')
        
        if duty_type in ['specific', 'combined'] and specific_rate is None:
            raise ValueError(f"–î–ª—è duty_type={duty_type} –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω specific_rate")
        
        return values


class RouteKeys:
    """–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
    HIGHWAY_RAIL = "highway_rail"
    HIGHWAY_AIR = "highway_air"
    HIGHWAY_CONTRACT = "highway_contract"
    PROLOGIX = "prologix"
    SEA_CONTAINER = "sea_container"
    
    @classmethod
    def all(cls) -> List[str]:
        return [
            cls.HIGHWAY_RAIL,
            cls.HIGHWAY_AIR,
            cls.HIGHWAY_CONTRACT,
            cls.PROLOGIX,
            cls.SEA_CONTAINER
        ]
    
    @classmethod
    def validate(cls, route_key: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª—é—á –º–∞—Ä—à—Ä—É—Ç–∞ –≤–∞–ª–∏–¥–Ω—ã–π"""
        return route_key in cls.all()


class CalculationRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—á—ë—Ç (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)"""
    product_name: str = Field(..., min_length=1, max_length=500)
    price_yuan: float = Field(..., gt=0)
    weight_kg: Optional[float] = Field(None, gt=0)
    quantity: int = Field(..., gt=0)
    markup: float = Field(1.7, gt=1.0)
    
    # Packing (–¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤)
    packing_units_per_box: Optional[int] = Field(None, gt=0)
    packing_box_weight: Optional[float] = Field(None, gt=0)
    packing_box_length: Optional[float] = Field(None, gt=0)
    packing_box_width: Optional[float] = Field(None, gt=0)
    packing_box_height: Optional[float] = Field(None, gt=0)
    
    # –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π –º–∞—Ä—à—Ä—É—Ç–æ–≤)
    custom_logistics: Optional[Dict[str, CustomLogisticsParams]] = None
    forced_category: Optional[str] = None
    
    # Legacy –ø–æ–ª—è
    product_url: Optional[str] = ""
    custom_rate: Optional[float] = None  # Deprecated, –∏—Å–ø–æ–ª—å–∑—É–µ–º custom_logistics
    delivery_type: str = "rail"  # Deprecated
    
    @validator('custom_logistics')
    def validate_route_keys(cls, v):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤–∞–ª–∏–¥–Ω—ã–µ"""
        if v is None:
            return v
        
        invalid_keys = [k for k in v.keys() if not RouteKeys.validate(k)]
        if invalid_keys:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã: {invalid_keys}. –î–æ–ø—É—Å—Ç–∏–º—ã–µ: {RouteKeys.all()}")
        
        return v
    
    @root_validator
    def validate_weight_source(cls, values):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–µ—Å–∞"""
        weight = values.get('weight_kg')
        packing_weight = values.get('packing_box_weight')
        packing_units = values.get('packing_units_per_box')
        
        has_weight = weight is not None and weight > 0
        has_packing = all([packing_weight, packing_units])
        
        if not has_weight and not has_packing:
            raise ValueError(
                "–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏–±–æ weight_kg, –ª–∏–±–æ (packing_box_weight + packing_units_per_box)"
            )
        
        return values


class CalculationResponse(BaseModel):
    """–û—Ç–≤–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–∞—Å—á—ë—Ç–∞"""
    id: Optional[int] = None
    product_name: str
    category: str
    forced_category: Optional[str] = None  # –ù–æ–≤–æ–µ –ø–æ–ª–µ
    custom_logistics: Optional[Dict[str, CustomLogisticsParams]] = None  # –ù–æ–≤–æ–µ –ø–æ–ª–µ
    
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    
    routes: Dict[str, Dict]  # –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at: Optional[datetime] = None
    version: Optional[int] = 1  # –î–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è


class CalculationVersion(BaseModel):
    """–í–µ—Ä—Å–∏—è —Ä–∞—Å—á—ë—Ç–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π)"""
    id: int
    calculation_id: int
    version: int
    custom_logistics: Optional[Dict[str, CustomLogisticsParams]]
    forced_category: Optional[str]
    cost_price_rub: float
    created_at: datetime
```

---

### –≠—Ç–∞–ø 1: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (1 –¥–µ–Ω—å)

#### 1.1 **–û–±–Ω–æ–≤–∏—Ç—å `save_calculation()` –∏ `update_calculation()`**

**database.py:**
```python
def save_calculation(data: dict) -> int:
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    conn, db_type = get_database_connection()
    cursor = conn.cursor()
    
    # –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º custom_logistics –≤ JSON
    custom_logistics_json = None
    if data.get('custom_logistics'):
        import json
        custom_logistics_json = json.dumps(data['custom_logistics'])
    
    if db_type == 'postgres':
        cursor.execute('''
            INSERT INTO calculations 
            (product_name, category, forced_category, custom_logistics,
             price_yuan, weight_kg, quantity, markup, custom_rate, 
             product_url, cost_price_rub, cost_price_usd, 
             sale_price_rub, sale_price_usd, profit_rub, profit_usd,
             ...) 
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, ...) 
            RETURNING id
        ''', (
            data['product_name'],
            data['category'],
            data.get('forced_category'),  # –ù–û–í–û–ï
            custom_logistics_json,         # –ù–û–í–û–ï
            data['price_yuan'],
            # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        ))
    
    # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è SQLite
```

#### 1.2 **–û–±–Ω–æ–≤–∏—Ç—å `_calculate_price_logic` –∏ `_update_calculation_logic`**

**main.py:**
```python
async def _calculate_price_logic(request: CalculationRequest):
    """–û–±—â–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)"""
    # ... —Ä–∞—Å—á—ë—Ç ...
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    calculation_data = {
        'product_name': request.product_name,
        'category': result.get('category', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'),
        'forced_category': request.forced_category,  # –ù–û–í–û–ï
        'custom_logistics': request.custom_logistics.dict() if request.custom_logistics else None,  # –ù–û–í–û–ï
        'price_yuan': request.price_yuan,
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    }
    
    calculation_id = save_calculation(calculation_data)
    result['id'] = calculation_id
    result['forced_category'] = request.forced_category  # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Ç–≤–µ—Ç
    result['custom_logistics'] = request.custom_logistics  # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Ç–≤–µ—Ç
    
    return result
```

#### 1.3 **–û–±–Ω–æ–≤–∏—Ç—å `get_calculation()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

**main.py:**
```python
@app.get("/api/v2/calculation/{calculation_id}")
async def get_calculation_v2(calculation_id: int):
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å–æ –í–°–ï–ú–ò –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    try:
        conn, db_type = get_database_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, product_name, category, forced_category, custom_logistics,
                   price_yuan, weight_kg, quantity, markup, 
                   cost_price_rub, cost_price_usd, sale_price_rub, sale_price_usd,
                   created_at
            FROM calculations 
            WHERE id = %s
        ''', (calculation_id,))
        
        row = cursor.fetchone()
        if not row:
            raise HTTPException(status_code=404, detail="–†–∞—Å—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        # –ü–∞—Ä—Å–∏–º custom_logistics –∏–∑ JSON
        custom_logistics = None
        if row['custom_logistics']:
            import json
            custom_logistics = json.loads(row['custom_logistics'])
        
        return {
            "id": row['id'],
            "product_name": row['product_name'],
            "category": row['category'],
            "forced_category": row['forced_category'],  # –ù–û–í–û–ï
            "custom_logistics": custom_logistics,        # –ù–û–í–û–ï
            # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

#### 1.4 **–û–±–Ω–æ–≤–∏—Ç—å Frontend –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

**static/js/v2/PriceCalculatorAppV2.js:**
```javascript
async loadCalculationById(calculationId) {
    try {
        const response = await axios.get(`/api/v2/calculation/${calculationId}`);
        const data = response.data;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º productData
        this.productData = {
            calculation_id: data.id,
            name: data.product_name,
            price_yuan: data.price_yuan,
            quantity: data.quantity,
            weight_kg: data.weight_kg,
            markup: data.markup,
            forcedCategory: data.forced_category || null,  // –ù–û–í–û–ï
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        };
        
        // –í–ê–ñ–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏
        if (data.custom_logistics) {
            this.customLogistics = data.custom_logistics;
            console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', this.customLogistics);
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å forced_category - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—É—é
        if (data.forced_category) {
            console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', data.forced_category);
        }
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        await this.performCalculation();
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≠—Ç–∞–ø 2
        this.currentStep = 2;
        this.calculationResult = response.data.routes;
        
        console.log('‚úÖ –†–∞—Å—á—ë—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—á—ë—Ç–∞:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—á—ë—Ç');
    }
}
```

---

### –≠—Ç–∞–ø 2: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï - Helper –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—ã–∑–æ–≤–æ–≤ (1 –¥–µ–Ω—å)

#### 2.1 **–°–æ–∑–¥–∞—Ç—å `_build_calculation_params()` helper**

**main.py:**
```python
def _build_calculation_params(
    request: CalculationRequest, 
    calculated_weight: Optional[float] = None
) -> dict:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è calculate_cost –∏–∑ request.
    –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞—Å—á—ë—Ç–∞.
    
    Args:
        request: –ó–∞–ø—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º–∏
        calculated_weight: –í–µ—Å (–µ—Å–ª–∏ —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω –∏–∑ packing)
    
    Returns:
        dict: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è **kwargs –≤ calculate_cost()
    """
    weight_kg = calculated_weight if calculated_weight is not None else request.weight_kg
    
    return {
        "product_name": request.product_name,
        "price_yuan": request.price_yuan,
        "weight_kg": weight_kg,
        "quantity": request.quantity,
        "custom_rate": request.custom_rate,  # Legacy
        "delivery_type": request.delivery_type,  # Legacy
        "markup": request.markup,
        "product_url": request.product_url,
        # Packing
        "packing_units_per_box": request.packing_units_per_box,
        "packing_box_weight": request.packing_box_weight,
        "packing_box_length": request.packing_box_length,
        "packing_box_width": request.packing_box_width,
        "packing_box_height": request.packing_box_height,
        # –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è
        "custom_logistics_params": request.custom_logistics.dict() if request.custom_logistics else None,
        "forced_category": request.forced_category
    }


async def _calculate_price_logic(request: CalculationRequest):
    """–û–±—â–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)"""
    # –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Å –∏–∑ packing –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    calculated_weight_kg = _calculate_weight_from_packing(request)
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ helper
    calc_params = _build_calculation_params(request, calculated_weight_kg)
    
    # –í—ã–∑—ã–≤–∞–µ–º —Ä–∞—Å—á—ë—Ç
    calc = get_calculator()
    result = calc.calculate_cost(**calc_params)
    
    # ... —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ...
    
    return result


async def _update_calculation_logic(calculation_id: int, request: CalculationRequest):
    """–û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)"""
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ –¢–û–¢ –ñ–ï helper
    calc_params = _build_calculation_params(request, request.weight_kg)
    
    # –í—ã–∑—ã–≤–∞–µ–º —Ä–∞—Å—á—ë—Ç
    calculator = PriceCalculator()
    result = calculator.calculate_cost(**calc_params)
    
    # ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î ...
    
    return result
```

**–í—ã–≥–æ–¥–∞:**
- ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –û–î–ù–û–ú –º–µ—Å—Ç–µ
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ endpoint
- ‚úÖ –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫–∞ –æ—à–∏–±–æ–∫

---

### –≠—Ç–∞–ø 3: –í–´–°–û–ö–ò–ô - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (2 –¥–Ω—è)

#### 3.1 **–°–æ–∑–¥–∞—Ç—å `cost_components.py`**

**models/cost_components.py:**
```python
from typing import Dict, Optional
from dataclasses import dataclass

@dataclass
class CostComponentResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏"""
    total_rub: float
    per_unit_rub: float
    details: Dict  # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è breakdown


class CostComponents:
    """–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤)"""
    
    def __init__(self, currencies: dict, formula_config: dict):
        self.currencies = currencies
        self.formula_config = formula_config
    
    def calculate_goods_cost(
        self, 
        price_yuan: float, 
        quantity: int,
        include_toni: bool = True,
        include_transfer: bool = False
    ) -> CostComponentResult:
        """
        –°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ —Å –∫–æ–º–∏—Å—Å–∏—è–º–∏.
        
        Args:
            price_yuan: –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤ —é–∞–Ω—è—Ö
            quantity: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü
            include_toni: –í–∫–ª—é—á–∞—Ç—å –ª–∏ –∫–æ–º–∏—Å—Å–∏—é –¢–æ–Ω–∏ (5%)
            include_transfer: –í–∫–ª—é—á–∞—Ç—å –ª–∏ –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –ø–µ—Ä–µ–≤–æ–¥ (18%)
        
        Returns:
            CostComponentResult —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
        """
        base_rub = price_yuan * self.currencies["yuan_to_rub"]
        
        toni_commission = base_rub * 0.05 if include_toni else 0
        
        if include_transfer:
            transfer_commission = (base_rub + toni_commission) * 0.18
        else:
            transfer_commission = 0
        
        total_per_unit = base_rub + toni_commission + transfer_commission
        
        return CostComponentResult(
            total_rub=total_per_unit * quantity,
            per_unit_rub=total_per_unit,
            details={
                "base_rub": base_rub,
                "toni_commission_rub": toni_commission,
                "transfer_commission_rub": transfer_commission,
                "toni_commission_pct": 5.0 if include_toni else 0,
                "transfer_commission_pct": 18.0 if include_transfer else 0
            }
        )
    
    def calculate_local_delivery(
        self, 
        weight_kg: float, 
        quantity: int
    ) -> CostComponentResult:
        """–õ–æ–∫–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –ö–∏—Ç–∞–µ (2¬•/–∫–≥)"""
        rate = self.formula_config.local_delivery_rate_yuan_per_kg or 2.0
        per_unit_yuan = rate * weight_kg
        per_unit_rub = per_unit_yuan * self.currencies["yuan_to_rub"]
        
        return CostComponentResult(
            total_rub=per_unit_rub * quantity,
            per_unit_rub=per_unit_rub,
            details={
                "rate_yuan_per_kg": rate,
                "per_unit_yuan": per_unit_yuan,
                "total_yuan": per_unit_yuan * quantity
            }
        )
    
    def calculate_msk_pickup(self, quantity: int) -> CostComponentResult:
        """–ó–∞–±–æ—Ä –≤ –ú–°–ö (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞)"""
        total = self.formula_config.msk_pickup_total_rub or 1000
        return CostComponentResult(
            total_rub=total,
            per_unit_rub=total / quantity,
            details={"fixed_cost_rub": total}
        )
    
    def calculate_other_costs(
        self, 
        base_cost_rub: float, 
        quantity: int
    ) -> CostComponentResult:
        """–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (2.5% –æ—Ç –±–∞–∑–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏)"""
        percent = self.formula_config.other_costs_percent or 2.5
        total = base_cost_rub * (percent / 100)
        return CostComponentResult(
            total_rub=total,
            per_unit_rub=total / quantity,
            details={"percent": percent}
        )
```

---

### –≠—Ç–∞–ø 4: –í–´–°–û–ö–ò–ô - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (3-4 –¥–Ω—è)

#### 4.1 **–°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `BaseRoute`**

**models/routes/base_route.py:**
```python
from abc import ABC, abstractmethod
from typing import Dict, Optional
from ..cost_components import CostComponents, CostComponentResult

class BaseRoute(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
    
    def __init__(
        self, 
        route_key: str, 
        route_name: str, 
        delivery_days: int,
        cost_components: CostComponents
    ):
        self.route_key = route_key
        self.route_name = route_name
        self.delivery_days = delivery_days
        self.components = cost_components
    
    @abstractmethod
    def calculate_logistics(
        self, 
        **kwargs
    ) -> CostComponentResult:
        """
        –†–∞—Å—á—ë—Ç –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞).
        –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –ø–æ–¥–∫–ª–∞—Å—Å–∞—Ö.
        """
        pass
    
    @abstractmethod
    def requires_customs(self) -> bool:
        """–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Ä–∞—Å—á—ë—Ç –ø–æ—à–ª–∏–Ω –∏ –ù–î–° –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞"""
        pass
    
    def calculate(
        self,
        price_yuan: float,
        weight_kg: float,
        quantity: int,
        markup: float,
        category: Optional[Dict] = None,
        custom_params: Optional[Dict] = None,
        **logistics_kwargs
    ) -> Dict:
        """
        –û–±—â–∏–π —Ä–∞—Å—á—ë—Ç –º–∞—Ä—à—Ä—É—Ç–∞ (–µ–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –í–°–ï–• –º–∞—Ä—à—Ä—É—Ç–æ–≤).
        
        Returns:
            {
                "name": str,
                "delivery_days": int,
                "cost_rub": float,
                "cost_usd": float,
                "per_unit": float,
                "sale_rub": float,
                "sale_usd": float,
                "sale_per_unit": float,
                "breakdown": {...}
            }
        """
        # 1. –°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ (—Å —É—á—ë—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞)
        goods_cost = self.components.calculate_goods_cost(
            price_yuan=price_yuan,
            quantity=quantity,
            include_toni=True,
            include_transfer=self._needs_transfer_commission()
        )
        
        # 2. –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è –≤—Å–µ—Ö)
        local_delivery = self.components.calculate_local_delivery(
            weight_kg=weight_kg,
            quantity=quantity
        )
        
        # 3. –õ–æ–≥–∏—Å—Ç–∏–∫–∞ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞)
        logistics = self.calculate_logistics(
            weight_kg=weight_kg,
            quantity=quantity,
            custom_params=custom_params,
            **logistics_kwargs
        )
        
        # 4. –ü–æ—à–ª–∏–Ω—ã + –ù–î–° (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
        customs_cost = None
        if self.requires_customs() and category:
            customs_cost = self._calculate_customs(
                goods_cost=goods_cost,
                logistics_cost=logistics,
                local_delivery=local_delivery,
                category=category,
                weight_kg=weight_kg,
                quantity=quantity,
                custom_params=custom_params
            )
        
        # 5. –ó–∞–±–æ—Ä –ú–°–ö
        msk_pickup = self.components.calculate_msk_pickup(quantity)
        
        # 6. –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (–æ—Ç –±–∞–∑–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
        base_for_other_costs = (
            goods_cost.total_rub + 
            local_delivery.total_rub
        )
        other_costs = self.components.calculate_other_costs(
            base_cost_rub=base_for_other_costs,
            quantity=quantity
        )
        
        # 7. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        total_cost_rub = (
            goods_cost.total_rub +
            logistics.total_rub +
            local_delivery.total_rub +
            msk_pickup.total_rub +
            other_costs.total_rub
        )
        
        if customs_cost:
            total_cost_rub += customs_cost.total_rub
        
        cost_per_unit = total_cost_rub / quantity
        total_cost_usd = total_cost_rub / self.components.currencies["usd_to_rub"]
        
        # 8. –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return {
            "name": self.route_name,
            "delivery_days": self.delivery_days,
            "cost_rub": round(total_cost_rub, 2),
            "cost_usd": round(total_cost_usd, 2),
            "per_unit": round(cost_per_unit, 2),
            "sale_rub": round(total_cost_rub * markup, 2),
            "sale_usd": round(total_cost_usd * markup, 2),
            "sale_per_unit": round(cost_per_unit * markup, 2),
            "breakdown": self._build_breakdown(
                goods_cost, logistics, local_delivery, 
                msk_pickup, other_costs, customs_cost
            )
        }
    
    def _needs_transfer_commission(self) -> bool:
        """–ù—É–∂–Ω–∞ –ª–∏ –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –ø–µ—Ä–µ–≤–æ–¥ (18%) –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞"""
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—Ç, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ Highway –ñ–î/–ê–≤–∏–∞
        return False
    
    def _build_breakdown(
        self, 
        goods: CostComponentResult,
        logistics: CostComponentResult,
        local_delivery: CostComponentResult,
        msk_pickup: CostComponentResult,
        other_costs: CostComponentResult,
        customs: Optional[CostComponentResult]
    ) -> Dict:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞—Ç—Ä–∞—Ç"""
        breakdown = {
            "goods": goods.details,
            "logistics": logistics.details,
            "local_delivery": local_delivery.details,
            "msk_pickup": msk_pickup.details,
            "other_costs": other_costs.details
        }
        
        if customs:
            breakdown["customs"] = customs.details
        
        return breakdown
    
    def _calculate_customs(
        self,
        goods_cost: CostComponentResult,
        logistics_cost: CostComponentResult,
        local_delivery: CostComponentResult,
        category: Dict,
        weight_kg: float,
        quantity: int,
        custom_params: Optional[Dict] = None
    ) -> CostComponentResult:
        """–†–∞—Å—á—ë—Ç –ø–æ—à–ª–∏–Ω –∏ –ù–î–° (–æ–±—â–∞—è –ª–æ–≥–∏–∫–∞)"""
        # –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        customs_value_rub = (
            goods_cost.total_rub +
            logistics_cost.total_rub +
            local_delivery.total_rub
        )
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫–∏ –ø–æ—à–ª–∏–Ω (—Å —É—á—ë—Ç–æ–º –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
        duty_rate, vat_rate, duty_type, specific_rate = self._get_duty_rates(
            category, custom_params
        )
        
        # –†–∞—Å—á—ë—Ç –ø–æ—à–ª–∏–Ω (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–µ—Å–æ–≤—ã—Ö)
        if duty_type == "specific":
            # –¢–æ–ª—å–∫–æ –≤–µ—Å–æ–≤—ã–µ
            duty_rub = self._calculate_specific_duty(
                specific_rate, weight_kg, quantity
            )
        elif duty_type == "combined":
            # –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –ò–õ–ò –≤–µ—Å–æ–≤—ã–µ (—á—Ç–æ –±–æ–ª—å—à–µ)
            ad_valorem = customs_value_rub * duty_rate
            specific = self._calculate_specific_duty(
                specific_rate, weight_kg, quantity
            )
            duty_rub = max(ad_valorem, specific)
        else:
            # –¢–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ
            duty_rub = customs_value_rub * duty_rate
        
        # –ù–î–°
        vat_rub = (customs_value_rub + duty_rub) * vat_rate
        
        return CostComponentResult(
            total_rub=duty_rub + vat_rub,
            per_unit_rub=(duty_rub + vat_rub) / quantity,
            details={
                "duty_rate": duty_rate,
                "vat_rate": vat_rate,
                "duty_type": duty_type,
                "specific_rate": specific_rate,
                "duty_rub": duty_rub,
                "vat_rub": vat_rub,
                "customs_value_rub": customs_value_rub
            }
        )
```

#### 4.2 **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤**

**models/routes/highway_rail.py:**
```python
from .base_route import BaseRoute
from ..cost_components import CostComponentResult

class HighwayRailRoute(BaseRoute):
    """Highway –ñ–î - —Å –∫–æ–º–∏—Å—Å–∏–µ–π –∑–∞ –ø–µ—Ä–µ–≤–æ–¥ (18%)"""
    
    def __init__(self, cost_components):
        super().__init__(
            route_key="highway_rail",
            route_name="Highway –ñ–î",
            delivery_days=25,
            cost_components=cost_components
        )
    
    def _needs_transfer_commission(self) -> bool:
        """Highway –ñ–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –ø–µ—Ä–µ–≤–æ–¥"""
        return True
    
    def requires_customs(self) -> bool:
        """Highway –ñ–î –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—à–ª–∏–Ω/–ù–î–°"""
        return False
    
    def calculate_logistics(
        self, 
        weight_kg: float,
        quantity: int,
        base_rate: float,
        density_surcharge: float = 0,
        custom_params: Optional[Dict] = None,
        **kwargs
    ) -> CostComponentResult:
        """–õ–æ–≥–∏—Å—Ç–∏–∫–∞ Highway –ñ–î ($/–∫–≥ —Å –Ω–∞–¥–±–∞–≤–∫–æ–π –∑–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å)"""
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å—Ç–∞–≤–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if custom_params and custom_params.get('custom_rate') is not None:
            base_rate = custom_params['custom_rate']
        
        total_rate_usd = base_rate + density_surcharge
        cost_per_unit_usd = weight_kg * total_rate_usd
        cost_per_unit_rub = cost_per_unit_usd * self.components.currencies["usd_to_rub"]
        
        return CostComponentResult(
            total_rub=cost_per_unit_rub * quantity,
            per_unit_rub=cost_per_unit_rub,
            details={
                "rate_usd_per_kg": total_rate_usd,
                "base_rate_usd": base_rate,
                "density_surcharge_usd": density_surcharge,
                "weight_kg": weight_kg
            }
        )
```

**models/routes/prologix.py:**
```python
class PrologixRoute(BaseRoute):
    """Prologix - —Ä–∞—Å—á—ë—Ç –ø–æ –∫—É–±–æ–º–µ—Ç—Ä–∞–º —Å –ø–æ—à–ª–∏–Ω–∞–º–∏"""
    
    def __init__(self, cost_components, prologix_rates):
        super().__init__(
            route_key="prologix",
            route_name="Prologix",
            delivery_days=30,
            cost_components=cost_components
        )
        self.rates = prologix_rates
    
    def requires_customs(self) -> bool:
        """Prologix —Ç—Ä–µ–±—É–µ—Ç –ø–æ—à–ª–∏–Ω/–ù–î–°"""
        return True
    
    def calculate_logistics(
        self, 
        volume_m3: float,
        quantity: int,
        custom_params: Optional[Dict] = None,
        **kwargs
    ) -> CostComponentResult:
        """–õ–æ–≥–∏—Å—Ç–∏–∫–∞ Prologix (—Ä—É–±/–º¬≥)"""
        # –ù–∞—Ö–æ–¥–∏–º —Ç–∞—Ä–∏—Ñ –ø–æ –æ–±—ä—ë–º—É
        rate_rub_per_m3 = self._get_rate_for_volume(volume_m3)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å—Ç–∞–≤–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if custom_params and custom_params.get('custom_rate') is not None:
            rate_rub_per_m3 = custom_params['custom_rate']
        
        total_rub = volume_m3 * rate_rub_per_m3
        
        return CostComponentResult(
            total_rub=total_rub,
            per_unit_rub=total_rub / quantity,
            details={
                "rate_rub_per_m3": rate_rub_per_m3,
                "volume_m3": volume_m3
            }
        )
    
    def _get_rate_for_volume(self, volume_m3: float) -> float:
        """–ù–∞—Ö–æ–¥–∏—Ç —Ç–∞—Ä–∏—Ñ –ø–æ –æ–±—ä—ë–º—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        for tariff in self.rates["tariffs"]:
            if tariff["volume_min"] <= volume_m3 <= tariff["volume_max"]:
                return tariff["rate_rub_per_m3"]
        
        # Fallback
        return self.rates["tariffs"][-1]["rate_rub_per_m3"]
```

---

### –≠—Ç–∞–ø 5: –°–†–ï–î–ù–ò–ô - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 1-2 –¥–Ω—è)

#### 5.1 **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏**

```python
def update_calculation(calculation_id: int, data: dict) -> int:
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏"""
    conn, db_type = get_database_connection()
    cursor = conn.cursor()
    
    # 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
    cursor.execute("SELECT version FROM calculations WHERE id = %s", (calculation_id,))
    current_version = cursor.fetchone()['version'] or 1
    next_version = current_version + 1
    
    # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é
    cursor.execute('''
        INSERT INTO calculation_versions 
        (calculation_id, version, custom_logistics, forced_category, 
         cost_price_rub, cost_price_usd, sale_price_rub, sale_price_usd)
        SELECT id, version, custom_logistics, forced_category,
               cost_price_rub, cost_price_usd, sale_price_rub, sale_price_usd
        FROM calculations WHERE id = %s
    ''', (calculation_id,))
    
    # 3. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–ø–∏—Å—å —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
    cursor.execute('''
        UPDATE calculations 
        SET ..., version = %s
        WHERE id = %s
    ''', (..., next_version, calculation_id))
    
    conn.commit()
    return calculation_id
```

---

## üìã –ü–û–†–Ø–î–û–ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï (–ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è)

1. **–î–µ–Ω—å 1-2: –≠—Ç–∞–ø 0.1** - –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î + –º–æ–¥–µ–ª–∏ Pydantic
   - SQL –º–∏–≥—Ä–∞—Ü–∏—è (custom_logistics, forced_category)
   - –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ (CalculationRequest, CalculationResponse)
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

2. **–î–µ–Ω—å 3: –≠—Ç–∞–ø 1** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å save_calculation()
   - –û–±–Ω–æ–≤–∏—Ç—å get_calculation()
   - –û–±–Ω–æ–≤–∏—Ç—å frontend loadCalculationById()

3. **–î–µ–Ω—å 4: –≠—Ç–∞–ø 2** - Helper –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –°–æ–∑–¥–∞—Ç—å _build_calculation_params()
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ calculate_cost()

4. **–î–µ–Ω—å 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á—ë—Ç —Å "–ù–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π"
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–´–°–û–ö–û–ï (–≤—Ç–æ—Ä–∞—è –Ω–µ–¥–µ–ª—è)

5. **–î–µ–Ω—å 6-7: –≠—Ç–∞–ø 3** - –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - –°–æ–∑–¥–∞—Ç—å CostComponents
   - –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –æ–±—â—É—é –ª–æ–≥–∏–∫—É

6. **–î–µ–Ω—å 8-10: –≠—Ç–∞–ø 4** - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - BaseRoute
   - HighwayRailRoute, HighwayAirRoute
   - PrologixRoute, SeaContainerRoute

7. **–î–µ–Ω—å 11: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã calculate_*_cost()
   - –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

### ‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–∑–∂–µ)

8. **–≠—Ç–∞–ø 5** - –í–µ—Ä—Å–∏–∏ —Ä–∞—Å—á—ë—Ç–æ–≤ (–µ—Å–ª–∏ –±—É–¥–µ—Ç –Ω—É–∂–Ω–æ)

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–∞ 1 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ):
- ‚úÖ "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–û–õ–ù–û–°–¢–¨–Æ
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úÖ –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
- ‚úÖ –¶–∏—Ñ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–∞ 2:
- ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –û–î–ù–û–ú –º–µ—Å—Ç–µ
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ endpoint

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–æ–≤ 3-4:
- ‚úÖ –ö–æ–¥ —Å–æ–∫—Ä–∞—â—ë–Ω —Å 4,600 –¥–æ ~2,000 —Å—Ç—Ä–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: 1 –¥–µ–Ω—å (–Ω–∞—Å–ª–µ–¥—É–µ–º BaseRoute)
- ‚úÖ –ö–∞–∂–¥—ã–π –º–∞—Ä—à—Ä—É—Ç –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏

---

## ‚ö†Ô∏è –†–ò–°–ö–ò

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-----------|
| –°–ª–æ–º–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤ | –°—Ä–µ–¥–Ω—è—è | –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ë–î + —Ç–µ—Å—Ç—ã |
| –ü–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ù–∏–∑–∫–∞—è | –ë—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ |
| –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤ | –°—Ä–µ–¥–Ω—è—è | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ legacy –ø–æ–ª–µ–π (custom_rate) |
| –£–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è —Ä–∞—Å—á—ë—Ç–∞ | –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ |

---

## üìù –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –°–¢–ê–†–¢–û–ú

- [ ] –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î (SQLite + PostgreSQL)
- [ ] –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É `refactoring/v2-with-custom-params`
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (baseline)
- [ ] –î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫)

---

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∏–Ω–∞—Ç—å? –ù–∞—á–Ω—ë–º —Å –≠—Ç–∞–ø–∞ 0.1 - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î!** üöÄ





