# V3 UI - Рефакторинг Position + Calculation ✅

## Дата: 13.10.2025

---

## 🎯 ЦЕЛЬ РЕФАКТОРИНГА

Правильно разделить монолитную форму на **2 логические секции**:
1. **ТОВАР (Position)** - ЧТО мы продаем (создается 1 раз)
2. **РАСЧЁТ (Calculation)** - ОТ КОГО покупаем и СКОЛЬКО (создается для каждой фабрики/тиража)

---

## ✅ ЧТО СДЕЛАНО

### 📦 СЕКЦИЯ 1: ТОВАР (Position)

Поля относятся к **позиции** (создается 1 раз, используется многократно):

```javascript
position: {
    name: '',           // Название товара
    category: '',       // Категория (автоопределение)
    description: '',    // Описание товара
    customization: '',  // Кастомизация
    photos: []          // Фотографии (основная + доп)
}
```

**UI:**
```
┌─────────────────────────────────────┐
│ 📦 Товар                            │
├─────────────────────────────────────┤
│ [Название товара]                   │
│ [Категория] (readonly, серый)       │
│ [Описание товара] (textarea)        │
│                                     │
│ 📸 Фотографии:                      │
│ [□ основная] [□] [□]                │
│                                     │
│ [Кастомизация] (textarea)           │
└─────────────────────────────────────┘
```

---

### 💰 СЕКЦИЯ 2: РАСЧЁТ (Calculation)

Все данные **расчёта** (создается для каждой фабрики/тиража):

```javascript
calculation: {
    // Фабрика
    factory_url: '',
    
    // Основной расчёт
    price_yuan: 0,
    quantity: 1000,
    production_time_days: 0,  // ← Срок производства
    
    // Режим расчёта
    detailedMode: false,
    weight_kg: 0.2,
    
    // Паккинг (если детальный)
    packing_units_per_box: 0,
    packing_box_weight: 0,
    packing_box_length: 0,
    packing_box_width: 0,
    packing_box_height: 0,
    
    // Образец (отдельный блок)
    sample_time_days: 0,
    sample_price_yuan: 0,
    
    // Наценка (в конце)
    markup: 1.7
}
```

**UI:**
```
┌─────────────────────────────────────┐
│ 💰 Расчёт                           │
├─────────────────────────────────────┤
│ 🏭 Фабрика:                         │
│ [WeChat/URL] [Из списка▼]          │
│                                     │
│ Основные параметры:                 │
│ [Цена ¥] [Кол-во] [Срок произв.]   │
│                                     │
│ ⚙️ ○ Быстрый ● Детальный            │
│ [Вес] ИЛИ [Паккинг поля...]        │
│                                     │
│ 🎨 Образец:                         │
│ [Срок образца] [Цена образца]      │
│                                     │
│ 💵 Наценка:                         │
│ [Наценка 1.7]                       │
│                                     │
│ [Рассчитать]                        │
└─────────────────────────────────────┘
```

---

## 🎨 НОВЫЕ СТИЛИ

### Form Sections
```css
.form-section {
    margin-bottom: 24px;
    padding: 20px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin: 0 0 16px 0;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
}
```

### Subsections (Образец, Наценка)
```css
.sample-section,
.markup-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}
```

---

## 📊 ЛОГИКА РАСПОЛОЖЕНИЯ ПОЛЕЙ

### ✅ ПОЗИЦИЯ (Position)
1. **Название товара** - основа позиции
2. **Категория** - для расчёта логистики
3. **Описание** - характеристики товара
4. **Фотографии** - визуал (основная = первая)
5. **Кастомизация** - требования к печати/гравировке

### ✅ РАСЧЁТ (Calculation)
1. **Фабрика** - от кого покупаем
2. **Цена, Кол-во, Срок производства** - основа расчёта
3. **Режим** - быстрый (вес) или детальный (паккинг)
4. **Образец** - срок и цена (отдельный блок)
5. **Наценка** - финальный параметр (в конце)

---

## 🔄 ОТЛИЧИЯ ОТ СТАРОЙ ВЕРСИИ

### БЫЛО (монолитная форма):
```javascript
form: {
    product_name: '',
    category: '',
    price_yuan: 0,
    quantity: 1000,
    weight_kg: 0.2,
    markup: 1.7,
    product_url: '',
    customization: '',
    production_time_days: 0,
    sample_time_days: 0,
    sample_price_yuan: 0,
    // ... все вместе
}
```

### СТАЛО (разделение):
```javascript
// ПОЗИЦИЯ - создается 1 раз
position: {
    name: '',
    category: '',
    description: '',
    customization: '',
    photos: []
},

// РАСЧЁТ - создается для каждой фабрики
calculation: {
    factory_url: '',
    price_yuan: 0,
    quantity: 1000,
    production_time_days: 0,
    detailedMode: false,
    weight_kg: 0.2,
    packing_*: ...,
    sample_time_days: 0,
    sample_price_yuan: 0,
    markup: 1.7
}
```

---

## 🎯 ПРЕИМУЩЕСТВА НОВОЙ СТРУКТУРЫ

### 1. Логическое разделение
- ✅ Понятно, что относится к товару
- ✅ Понятно, что относится к расчёту от фабрики
- ✅ Визуально разделено секциями

### 2. Готовность к БД
- ✅ `position` → `v3_positions` (1 запись)
- ✅ `calculation` → `v3_calculations` (N записей для 1 position)
- ✅ Прямое соответствие моделям

### 3. UX улучшения
- ✅ Секции с заголовками 📦💰
- ✅ Визуальная группировка полей
- ✅ Образец и Наценка выделены как подсекции
- ✅ Логичный порядок заполнения: товар → расчёт

### 4. Расширяемость
- ✅ Легко добавить новые поля в нужную секцию
- ✅ Можно добавить секцию "История расчётов для позиции"
- ✅ Подготовка к полноценному функционалу Positions

---

## 📁 ФАЙЛЫ

### Изменённые:
- `static/js/v3/QuickModeV3.js` - полностью переписан
- `static/css/v3-styles.css` - добавлены стили секций

### Backup:
- `static/js/v3/QuickModeV3_OLD_BACKUP.js` - старая версия

---

## 🧪 КАК ПРОТЕСТИРОВАТЬ

### 1. Откройте V3
```
https://price-calculator-production.up.railway.app/v3
```

### 2. Проверьте СЕКЦИЮ "ТОВАР"
- ✅ Заголовок "📦 Товар"
- ✅ Поля: Название, Категория, Описание
- ✅ Фотографии с drag & drop
- ✅ Кастомизация

### 3. Проверьте СЕКЦИЮ "РАСЧЁТ"
- ✅ Заголовок "💰 Расчёт"
- ✅ Подзаголовок "🏭 Фабрика"
- ✅ Основные параметры в одну строку
- ✅ Срок производства рядом с ценой/количеством
- ✅ Режим (быстрый/детальный)
- ✅ Подсекция "🎨 Образец"
- ✅ Подсекция "💵 Наценка" (в конце)

### 4. Проверьте автоопределение
- ✅ Введите "Футболка" → категория определится
- ✅ Категория редактируемая (можно исправить)

### 5. Проверьте расчёт
- ✅ Заполните все поля
- ✅ Нажмите "Рассчитать"
- ✅ Результаты в компактном виде

---

## 📝 СЛЕДУЮЩИЕ ШАГИ

### Этап 2: Backend интеграция
1. **API для создания Position** - `/api/v3/positions`
2. **API для создания Calculation** - `/api/v3/calculations`
3. **Связка Position ↔ Calculation** - position_id

### Этап 3: SFTP загрузка фото
1. **Загрузка при создании Position**
2. **Получение URLs для `design_files_urls`**

### Этап 4: Полноценный функционал Positions
1. **Tab "Позиции"** - список всех позиций
2. **Карточка позиции** - фото + расчёты от разных фабрик
3. **Сравнение расчётов** - side-by-side

---

## ✅ ГОТОВО!

**Статус:** PRODUCTION READY (фронтенд)  
**Деплой:** Railway auto-deploy завершён  
**Время работы:** ~2 часа

🎉 Рефакторинг завершён! Теперь структура соответствует БД и логике бизнеса!


