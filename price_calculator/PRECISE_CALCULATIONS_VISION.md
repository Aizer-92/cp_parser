# 🎯 Видение: Двухэтапный расчет логистики

**Дата создания:** 06.10.2025  
**Статус:** В разработке (Этап 1 завершен - Надбавки за плотность)

---

## 📋 Общая концепция

Эволюция функции "Точные расчеты" от простого калькулятора к профессиональной системе расчета логистики с несколькими маршрутами.

### Ключевая идея: Два этапа расчета

#### **Этап 1: Данные от фабрики**
Сбор информации о товаре и упаковке:
- Характеристики товара (название, цена, вес единицы)
- Данные упаковки (единиц в коробке, вес коробки)
- Габариты коробки (длина, ширина, высота в метрах)
- Тираж (количество единиц)

#### **Этап 2: Логистический расчет**
На основе данных этапа 1 рассчитываем стоимость по **5 маршрутам**:
1. **Highway Company (ЖД/Авиа)** - с надбавкой за плотность ✅ РЕАЛИЗОВАНО
2. **Highway под контракт** - фиксированные ставки ✅ РЕАЛИЗОВАНО
3. **Prologix** - по кубометрам, тарифы зависят от объема 🔜 TODO
4. **Контейнер** - фиксированная стоимость контейнера / груз 🔜 TODO
5. **Cargo (Казахстан)** - наземка, ~25 дней, альтернативный маршрут 🔜 TODO

---

## ✅ Что уже реализовано (Этап 1)

### 1. Надбавки за плотность для Highway Company

**Статус:** ✅ Полностью работает

**Реализация:**
- **Конфиг:** `config/density_surcharges.yaml`
  - Таблица для ЖД (rail): 36 точек плотности
  - Таблица для Авиа (air): 24 точек плотности
  
- **Backend:** `price_calculator.py`
  - `load_density_surcharges()` - загрузка таблиц из YAML
  - `get_density_surcharge()` - расчет с линейной интерполяцией
  - Интеграция в `calculate_cost()` с расчетом плотности

- **API:** `main.py`
  - Передача данных упаковки (вес, длина, ширина, высота в метрах)
  - Добавлено поле `density_info` в `CalculationResponse`

- **UI:** `ResultsDisplay.js`
  - Детализация логистической ставки
  - Отображение базовой ставки + надбавка = итоговая
  - Цветовая индикация (красный - есть надбавка, зеленый - оптимально)

**Формула расчета:**
```
Объем коробки (м³) = длина × ширина × высота
Плотность (кг/м³) = вес коробки / объем
Надбавка $/кг = таблица[плотность, тип_доставки] (с интерполяцией)
Итоговая ставка = базовая ставка + надбавка
```

**Пример работы:**
- Легкий товар (50 кг/м³): +$4.68/кг надбавка
- Оптимальный товар (305 кг/м³): $0.00 надбавка
- Тяжелый товар (>180 кг/м³): $0.00 надбавка

---

## 🔜 Следующие шаги (Этап 2)

### Объединение Quick и Precise расчетов

**Идея:** Добавить checkbox "Считать только по весу" в форму Precise

- ✅ **Если checkbox включен:**
  - Не запрашивать габариты коробки
  - Использовать стандартную плотность категории
  - Быстрый расчет (как Quick, но с пакингом)

- ✅ **Если checkbox выключен:**
  - Запрашивать все данные упаковки
  - Рассчитывать реальную плотность
  - Применять надбавку за плотность

**UI остается прежним** - никаких изменений в стиле!

---

### 3. Prologix - расчет по кубометрам

**Концепция:**
- Тарифы зависят от общего объема груза
- Чем больше объем → дешевле ставка за м³

**Формула:**
```
Объем 1 коробки = длина × ширина × высота (м³)
Количество коробок = тираж / единиц_в_коробке
Общий объем = объем_коробки × количество_коробок

Ставка $/м³ = тарифная_таблица[общий_объем]
Стоимость = общий_объем × ставка
```

**Данные для реализации:**
- Таблица тарифов Prologix (запросить у клиента)
- Пример: 0-5 м³ = $X, 5-10 м³ = $Y, 10-20 м³ = $Z

**TODO:**
- [ ] Создать `config/prologix_rates.yaml`
- [ ] Добавить метод `calculate_prologix_cost()`
- [ ] Добавить в результаты расчета

---

### 4. Контейнер - фиксированная стоимость

**Концепция:**
- Стоимость контейнера фиксирована (например, $X за 20 футов, $Y за 40 футов)
- Делим на объем груза клиента

**Формула:**
```
Объем груза = объем_коробки × количество_коробок
Емкость 20ft = 33 м³, 40ft = 67 м³

Если груз ≤ 33 м³:
  Стоимость_за_м³ = стоимость_20ft / 33
Иначе если груз ≤ 67 м³:
  Стоимость_за_м³ = стоимость_40ft / 67
Иначе:
  Несколько контейнеров

Итого = объем_груза × стоимость_за_м³
```

**Данные для реализации:**
- Стоимость контейнера 20ft
- Стоимость контейнера 40ft
- Время доставки

**TODO:**
- [ ] Создать `config/container_rates.yaml`
- [ ] Добавить метод `calculate_container_cost()`
- [ ] Логика выбора типа контейнера

---

### 5. Cargo (Казахстан) - наземная доставка

**Концепция:**
- Доставка через Казахстан наземным транспортом
- Среднее время: 25 дней
- Альтернативный маршрут для больших объемов

**Формула:**
```
Общий вес = вес_коробки × количество_коробок
Ставка $/кг = базовая_ставка_cargo
Стоимость = общий_вес × ставка
```

**Данные для реализации:**
- Базовая ставка $/кг для Cargo
- Сроки доставки (среднее/мин/макс)
- Ограничения по объему/весу

**TODO:**
- [ ] Добавить ставки Cargo в `config/logistics_rates.yaml`
- [ ] Добавить метод `calculate_cargo_cost()`
- [ ] Добавить информацию о сроках

---

## 🎨 UI/UX План

### Сохранение текущего стиля

**КРИТИЧЕСКИ ВАЖНО:** Не менять визуальный стиль!

Текущий UI:
- Чистый белый дизайн
- Синие акценты (#3b82f6)
- Табы для навигации
- Карточки результатов

### Новый экран: "Сравнение маршрутов"

После этапа 1 (ввод данных от фабрики) показывать таблицу с 5 маршрутами:

```
┌─────────────────────────────────────────────────────────────┐
│  Маршрут          │ Ставка    │ Стоимость  │ Срок  │ Выбрать│
├─────────────────────────────────────────────────────────────┤
│  Highway ЖД       │ $8.44/кг  │ 198,765₽   │ 35д   │   ○   │
│  Highway Авиа     │ $12.50/кг │ 289,450₽   │ 15д   │   ○   │
│  Highway Контракт │ $3.40/кг  │ 78,920₽    │ 40д   │   ○   │
│  Prologix         │ $45/м³    │ 165,340₽   │ 30д   │   ○   │
│  Контейнер 20ft   │ фикс      │ 142,890₽   │ 45д   │   ○   │
│  Cargo (КЗ)       │ $4.20/кг  │ 97,560₽    │ 25д   │   ○   │
└─────────────────────────────────────────────────────────────┘
```

После выбора маршрута → показывать детальный расчет как сейчас.

---

## 📊 Структура данных

### Входные данные (Этап 1)

```javascript
{
  // Товар
  product_name: "рюкзак",
  price_yuan: 60,
  weight_kg: 0.7,  // вес единицы
  quantity: 2000,
  
  // Упаковка
  packing_units_per_box: 24,
  packing_box_weight: 16.8,     // кг
  packing_box_length: 0.64,     // м
  packing_box_width: 0.40,      // м
  packing_box_height: 0.32,     // м
  
  // Опции
  calculate_by_weight_only: false  // новый checkbox
}
```

### Выходные данные (Этап 2)

```javascript
{
  // Базовые данные товара
  product_name: "...",
  quantity: 2000,
  
  // Данные плотности
  density_info: {
    density_kg_m3: 109.4,
    volume_m3: 0.064,
    has_density_data: true
  },
  
  // Результаты по каждому маршруту
  routes: {
    highway_rail: {
      name: "Highway ЖД",
      base_rate_usd: 7.27,
      density_surcharge_usd: 1.17,
      total_rate_usd: 8.44,
      total_cost_rub: 198765,
      delivery_days: 35
    },
    highway_air: { ... },
    highway_contract: { ... },
    prologix: {
      name: "Prologix",
      rate_per_m3: 45,
      total_volume_m3: 3.84,
      total_cost_rub: 165340,
      delivery_days: 30
    },
    container: { ... },
    cargo: { ... }
  },
  
  // Рекомендация (самый дешевый/оптимальный)
  recommended_route: "highway_contract"
}
```

---

## 🔧 Технические детали

### Файлы для модификации

#### Backend
- ✅ `price_calculator.py` - основная логика расчетов
- 🔜 `logistics_calculator.py` - новый модуль для всех маршрутов
- ✅ `config/density_surcharges.yaml` - таблицы плотности
- 🔜 `config/prologix_rates.yaml` - тарифы Prologix
- 🔜 `config/container_rates.yaml` - стоимость контейнеров
- 🔜 `config/cargo_rates.yaml` - ставки Cargo

#### API
- ✅ `main.py` - endpoints расчета
- 🔜 Новый endpoint: `POST /api/calculate-all-routes`

#### Frontend
- ✅ `ProductFormPrecise.js` - форма ввода данных
- 🔜 Добавить checkbox "Считать только по весу"
- ✅ `ResultsDisplay.js` - отображение результатов
- 🔜 `RoutesComparison.js` - новый компонент сравнения маршрутов

---

## 📝 Changelog

### 06.10.2025 - Этап 1.1: Надбавки за плотность (ЗАВЕРШЕН)

**Добавлено:**
- ✅ Конфигурация плотности (`config/density_surcharges.yaml`)
- ✅ Функции расчета плотности с линейной интерполяцией
- ✅ Интеграция в основной расчет
- ✅ API поддержка (добавлено поле `density_info`)
- ✅ UI отображение детализации логистики

**Исправлено:**
- ✅ Размеры коробки в метрах (было: конвертация из см)
- ✅ Pydantic модель `CalculationResponse` - добавлено `density_info`

**Протестировано:**
- ✅ Легкий товар (50 кг/м³) → надбавка +$4.68/кг
- ✅ Оптимальный (305 кг/м³) → надбавка $0.00
- ✅ Тяжелый (>180 кг/м³) → надбавка $0.00
- ✅ UI корректно отображает детализацию

---

## 🎯 Приоритеты следующих задач

### Краткосрочные (1-2 недели)
1. **Объединение Quick/Precise** - добавить checkbox "только по весу"
2. **Prologix** - получить тарифы и реализовать расчет
3. **Cargo** - добавить базовые ставки

### Среднесрочные (2-4 недели)
4. **Контейнер** - логика выбора типа контейнера
5. **UI сравнения** - компонент `RoutesComparison.js`
6. **Рекомендации** - автоматический выбор оптимального маршрута

### Долгосрочные (1-2 месяца)
7. **История по маршрутам** - сохранение выбранного маршрута
8. **Аналитика** - какие маршруты чаще используются
9. **Экспорт** - PDF отчет со сравнением всех маршрутов

---

## 📚 Полезные ссылки

- Основной код: `/projects/price_calculator/`
- Конфиги: `/projects/price_calculator/config/`
- Vue Router миграция: `VUE_ROUTER_MIGRATION_SUMMARY.md`
- Тесты плотности: были в `test_density.py` (удален после проверки)

---

## 💡 Идеи для будущего

- **Автоматический выбор маршрута** на основе приоритета (скорость vs цена)
- **Калькулятор оптимизации** - "как упаковать чтобы снизить плотность"
- **Интеграция с ERP** - автоматическая загрузка данных о товарах
- **Мобильная версия** - сканирование коробок камерой для замеров
- **ML предсказание** - оптимальный маршрут на основе истории

---

**Последнее обновление:** 06.10.2025, 23:45  
**Автор:** Reshad + AI Assistant  
**Версия документа:** 1.0










