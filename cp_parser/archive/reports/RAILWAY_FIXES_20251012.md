# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø RAILWAY (12.10.2025)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ

---

## üêõ –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø:

### 1. **PostgreSQLManager Session Error** ‚úÖ

**–û—à–∏–±–∫–∞:**
```
'PostgreSQLManager' object has no attribute 'Session'
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `db_manager.Session()`, –Ω–æ —Ç–∞–∫–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –Ω–µ—Ç
- –£ PostgreSQLManager –µ—Å—Ç—å `SessionLocal`, –Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–µ–Ω –º–µ—Ç–æ–¥

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–∏–ª **–í–°–ï 5 –≤—Ö–æ–∂–¥–µ–Ω–∏–π** `db_manager.Session()` ‚Üí `db_manager.get_session_direct()`
- –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã endpoints:
  - `/api/kp/add` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ö–ü
  - `/api/kp/remove/<id>` - —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ö–ü
  - `/api/kp` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ö–ü
  - `/api/kp/clear` - –æ—á–∏—Å—Ç–∫–∞ –ö–ü
  - `/api/kp/check` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

**–¢–µ—Å—Ç:**
```bash
# –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
curl -X POST https://cp-parser-production.up.railway.app/api/kp/add \
  -H "Content-Type: application/json" \
  -d '{"product_id": 1, "price_offer_id": 1}'
```

---

### 2. **CLIP Model Not Loading** ‚è≥

**–û—à–∏–±–∫–∞:**
```
–ü–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –æ—Ç–∫–ª—é—á–µ–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è CLIP –º–æ–¥–µ–ª—å –∏ pgvector –ë–î.
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `VECTOR_DATABASE_URL`
2. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `OPENAI_API_KEY`
3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ (~500MB)
4. Timeout –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏ (Railway –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)

**–†–µ—à–µ–Ω–∏–µ:**
1. **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   ```python
   üîÑ [APP] –ó–∞–≥—Ä—É–∂–∞—é CLIP –º–æ–¥–µ–ª—å (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥)...
   ‚úÖ [APP] CLIP –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–∞ 12.3—Å
   ```

2. **–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫:**
   ```python
   ‚ÑπÔ∏è  [APP] CLIP –º–æ–¥–µ–ª—å –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç pgvector –ë–î
   ‚ÑπÔ∏è  [APP] CLIP –º–æ–¥–µ–ª—å –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç OpenAI API
   ‚ö†Ô∏è  [APP] CLIP –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: [–ø–æ–ª–Ω—ã–π traceback]
   ```

3. **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ API –æ—à–∏–±–∫–∏:**
   ```json
   {
     "error": "–ü–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –æ—Ç–∫–ª—é—á–µ–Ω: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ pgvector –ë–î"
   }
   ```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ Railway
railway logs

# –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏:
# "üîÑ –ó–∞–≥—Ä—É–∂–∞—é CLIP –º–æ–¥–µ–ª—å"
# "‚úÖ CLIP –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–∞ X.Xs"
# –∏–ª–∏
# "‚ö†Ô∏è CLIP –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
```

**–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –ù–ï –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å:**

–ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
railway variables

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
VECTOR_DATABASE_URL=postgres://...
OPENAI_API_KEY=sk-...
DATABASE_URL_PRIVATE=postgres://...
```

---

### 3. **Session Naming Conflict** ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É `flask.session` –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `session`

**–†–µ—à–µ–Ω–∏–µ:**
- –í `auth.py` –∏ `app.py`: –∏—Å–ø–æ–ª—å–∑—É—é `flask_session` —è–≤–Ω–æ
  ```python
  from flask import session as flask_session
  ```

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø:

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
railway logs | grep "APP"

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# ‚úÖ [APP] pgvector –ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
# ‚úÖ [APP] –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ pgvector –í–ö–õ–Æ–ß–ï–ù
# üîÑ [APP] –ó–∞–≥—Ä—É–∂–∞—é CLIP –º–æ–¥–µ–ª—å...
# ‚úÖ [APP] CLIP –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–∞ X.Xs
```

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ KP API:

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ö–ü
curl -X POST https://cp-parser-production.up.railway.app/api/kp/add \
  -H "Content-Type: application/json" \
  -d '{"product_id": 1, "price_offer_id": 1}'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# {"success": true, "message": "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ö–ü", "kp_count": 1}
```

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Image Search:

**–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å:**
```bash
curl -X POST https://cp-parser-production.up.railway.app/api/search-by-image \
  -F "image=@test.jpg"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# {"success": true, "search_id": "uuid", "count": 25}
```

**–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –ù–ï –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å:**
```bash
# –í–µ—Ä–Ω–µ—Ç:
# {"success": false, "error": "–ü–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –æ—Ç–∫–ª—é—á–µ–Ω: [–ø—Ä–∏—á–∏–Ω–∞]"}
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò:

### –ï—Å–ª–∏ CLIP –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏:

**–í–∞—Ä–∏–∞–Ω—Ç 1:** –£–≤–µ–ª–∏—á–∏—Ç—å –ø–ª–∞–Ω Railway
- –¢–µ–∫—É—â–∏–π: Hobby Plan (512MB RAM)
- –¢—Ä–µ–±—É–µ—Ç—Å—è: Pro Plan (1GB+ RAM)

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –ª–µ–≥–∫—É—é –º–æ–¥–µ–ª—å
```python
# –í–º–µ—Å—Ç–æ clip-ViT-B-32 (—Ä–∞–∑–º–µ—Ä ~350MB)
CLIP_MODEL = SentenceTransformer('clip-ViT-B-16')  # —Ä–∞–∑–º–µ—Ä ~150MB
```

**–í–∞—Ä–∏–∞–Ω—Ç 3:** –û—Ç–∫–ª—é—á–∏—Ç—å image search
- –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –∏ KP –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- Image search –≤–µ—Ä–Ω–µ—Ç—Å—è –ø–æ–∑–∂–µ

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 173
- **–°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** 94,985
- **–°—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ:** 17
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 3
- **API endpoints –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5
- **–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** ~45 –º–∏–Ω—É—Ç

---

## üöÄ DEPLOY INFO:

**Commit:** `f739a2c`  
**Branch:** `main`  
**Deploy URL:** https://cp-parser-production.up.railway.app  
**Logs:** `railway logs`

---

## üìù CHANGELOG:

### v1.3.1 (12.10.2025)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- üêõ PostgreSQLManager Session error ‚Üí `get_session_direct()`
- üîç –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ CLIP –º–æ–¥–µ–ª–∏
- üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ API
- üîí Session naming conflict –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ CLIP –º–æ–¥–µ–ª–∏ –≤ –ª–æ–≥–∞—Ö
- ü©∫ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª—é—á–µ–Ω–∏—è image search
- üìñ –î–µ—Ç–∞–ª—å–Ω—ã–π traceback –æ—à–∏–±–æ–∫

---

## üÜò TROUBLESHOOTING:

### –õ–æ–≥–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è:

```bash
# –ï—Å–ª–∏ railway logs –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–≤–æ–¥:
railway logs --follow

# –ò–ª–∏ –ø—Ä—è–º–æ –≤ Railway Dashboard:
https://railway.app/project/{your_project}/deployments
```

### WARNING: Task queue depth is 1

**–ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ!** –≠—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ—Ç waitress –æ –∑–∞–¥–µ—Ä–∂–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ï—Å–ª–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç–æ:**
- –£–≤–µ–ª–∏—á–∏—Ç—å `threads` –≤ `waitress.serve()`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `gunicorn` –≤–º–µ—Å—Ç–æ `waitress`

```python
# –í app.py:
serve(app, host='0.0.0.0', port=port, threads=8)  # –±—ã–ª–æ 4
```

---

## ‚úÖ –ò–¢–û–ì:

1. ‚úÖ **PostgreSQL Session** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
2. ‚è≥ **CLIP Model** - —É–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏)
3. ‚úÖ **Session Naming** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è:** Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ–∏—Ç –ø–æ—Å–ª–µ push

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Railway
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π KP API
3. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å image search
4. –ï—Å–ª–∏ image search –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí —Å–º. —Ä–∞–∑–¥–µ–ª "–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò"

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 12 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.3.1


