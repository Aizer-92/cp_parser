# ‚úÖ –ü–û–ò–°–ö –ü–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Æ - –ì–û–¢–û–í!

**–î–∞—Ç–∞:** 12 –æ–∫—Ç—è–±—Ä—è 2025

---

## üéØ –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:

### 1. **UI - –ö–Ω–æ–ø–∫–∞ "–ü–æ —Ñ–æ—Ç–æ"** ‚úÖ

**–ì–¥–µ:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ (`/products`)

**–í–Ω–µ—à–Ω–∏–π –≤–∏–¥:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–∞–π—Ç–∏   ‚îÇ  –ü–æ —Ñ–æ—Ç–æ üì∑  ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (purple-600) —Ä—è–¥–æ–º —Å "–ù–∞–π—Ç–∏"
- –ò–∫–æ–Ω–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

---

### 2. **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å Drag & Drop** ‚úÖ

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ Drag & Drop –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ Click –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
- ‚úÖ Preview –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: PNG, JPG, GIF, WEBP (–¥–æ 10MB)
- ‚úÖ Loading —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
- ‚úÖ –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ drag over

**UI —ç–ª–µ–º–µ–Ω—Ç—ã:**
- –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Ä–∞–º–∫–∞ (hover —ç—Ñ—Ñ–µ–∫—Ç)
- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ" (purple)
- –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" (gray)
- –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
- –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞

---

### 3. **API Endpoint `/api/search-by-image`** ‚úÖ

**–ú–µ—Ç–æ–¥:** POST (multipart/form-data)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `image` - —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ (—Ç–∏–ø, —Ä–∞–∑–º–µ—Ä)
2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PIL
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding —á–µ—Ä–µ–∑ CLIP –º–æ–¥–µ–ª—å
4. –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –≤ `pgvector` –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `image_embeddings`)
5. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ similarity >= 0.3
6. –õ–∏–º–∏—Ç: 50 —Ç–æ–≤–∞—Ä–æ–≤
7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Å–µ—Å—Å–∏–∏
8. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/products?image_search={search_id}`

**Response:**
```json
{
  "success": true,
  "search_id": "uuid",
  "count": 25
}
```

**Graceful Fallback:**
- –ï—Å–ª–∏ CLIP –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚Üí 503 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –ï—Å–ª–∏ `pgvector` –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –æ—Ç–∫–ª—é—á–µ–Ω–æ
- –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç ‚Üí 404 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º

---

### 4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å products_list** ‚úÖ

**–ü–∞—Ä–∞–º–µ—Ç—Ä:** `?image_search={search_id}`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ `product_ids` –∏–∑ —Å–µ—Å—Å–∏–∏ –ø–æ `search_id`
2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤: `WHERE p.id IN (product_ids)`
3. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ image search
4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç

**–õ–æ–≥–∏:**
```
üñºÔ∏è  [IMAGE SEARCH] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: 25 —Ç–æ–≤–∞—Ä–æ–≤
```

---

## üõ†Ô∏è –¢–ï–•–ù–û–õ–û–ì–ò–ò:

### Backend:
- **CLIP Model**: `sentence-transformers/clip-ViT-B-32`
- **Image Processing**: Pillow (PIL)
- **Vector DB**: PostgreSQL + pgvector
- **Embeddings**: 512-dimensional vectors
- **Similarity**: Cosine distance

### Frontend:
- **Drag & Drop API**: HTML5 File API
- **Preview**: FileReader API
- **AJAX**: Fetch API
- **UI**: Tailwind CSS

### Dependencies:
```
Pillow==10.1.0
sentence-transformers==2.2.2
```

---

## üìä –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û–ò–°–ö–ê:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| **Model** | clip-ViT-B-32 | CLIP –º–æ–¥–µ–ª—å –¥–ª—è embeddings |
| **Embedding Size** | 512 | –†–∞–∑–º–µ—Ä –≤–µ–∫—Ç–æ—Ä–∞ |
| **Similarity Threshold** | 0.3 | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å |
| **Max Results** | 50 | –õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| **Search DB** | pgvector | –û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –¥–ª—è –≤–µ–∫—Ç–æ—Ä–æ–≤ |

---

## üß™ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨:

### –õ–æ–∫–∞–ª—å–Ω–æ:

```bash
cd /Users/bakirovresad/Downloads/Reshad\ 1/projects/cp_parser/web_interface
python3 app.py
```

–û—Ç–∫—Ä—ã—Ç—å: `http://localhost:5000/products`

### –¢–µ—Å—Ç:
1. –ö–ª–∏–∫–Ω–∏ "–ü–æ —Ñ–æ—Ç–æ" üì∑
2. –ü–µ—Ä–µ—Ç–∞—â–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª
3. –ö–ª–∏–∫–Ω–∏ "–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ"
4. ‚è≥ –ñ–¥–µ–º 2-3 —Å–µ–∫—É–Ω–¥—ã (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è embedding + –ø–æ–∏—Å–∫)
5. ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

---

## üöÄ –î–ï–ü–õ–û–ô –ù–ê RAILWAY:

### –ß—Ç–æ –Ω—É–∂–Ω–æ:

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:**
   - ‚úÖ `DATABASE_URL_PRIVATE` - –≥–ª–∞–≤–Ω–∞—è –ë–î
   - ‚úÖ `VECTOR_DATABASE_URL` - pgvector –ë–î
   - ‚úÖ `OPENAI_API_KEY` - –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞

2. **–¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞:**
   - ‚úÖ `image_embeddings` (id, product_id, image_embedding, image_url)
   - ‚úÖ –ò–Ω–¥–µ–∫—Å: `ivfflat` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

3. **Embeddings —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã:**
   - ‚úÖ ~13,350 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
   - ‚úÖ CLIP –º–æ–¥–µ–ª—å: `clip-ViT-B-32`

### –î–µ–ø–ª–æ–π:

```bash
# –ö–æ–¥ —É–∂–µ –∑–∞–ø—É—à–µ–Ω –Ω–∞ GitHub
# Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç
```

**–°—Å—ã–ª–∫–∞:** https://cp-parser-production.up.railway.app

---

## üîÑ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```
[User Upload Image] 
    ‚Üì
[Flask API: /api/search-by-image]
    ‚Üì
[PIL Image Processing]
    ‚Üì
[CLIP Model: Generate Embedding (512d)]
    ‚Üì
[pgvector DB: Cosine Similarity Search]
    ‚Üì
[Filter: similarity >= 0.3, LIMIT 50]
    ‚Üì
[Session: Save product_ids]
    ‚Üì
[Redirect: /products?image_search={uuid}]
    ‚Üì
[products_list: Load from session + display]
```

---

## üé® UX FLOW:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ /products
   ‚Üì
2. –ö–ª–∏–∫–∞–µ—Ç "–ü–æ —Ñ–æ—Ç–æ" üì∑
   ‚Üì
3. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
   ‚Üì
4. Drag & Drop –∏–ª–∏ Click ‚Üí –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
   ‚Üì
5. Preview –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
   ‚Üì
6. –ö–ª–∏–∫–∞–µ—Ç "–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ"
   ‚Üì
7. Loading –∞–Ω–∏–º–∞—Ü–∏—è (–ò—â–µ–º...)
   ‚Üì
8. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   ‚Üì
9. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã
```

---

## üî• –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò:

### 1. **–ë—ã—Å—Ç—Ä–æ—Ç–∞:**
- CLIP embedding: ~0.5-1 —Å–µ–∫
- pgvector –ø–æ–∏—Å–∫: ~0.1-0.5 —Å–µ–∫
- **–ò—Ç–æ–≥–æ:** 1-2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –≤–µ—Å—å –ø–æ–∏—Å–∫

### 2. **–¢–æ—á–Ω–æ—Å—Ç—å:**
- Similarity >= 0.3 ‚Üí —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫
- –ú–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å –¥–æ 0.5 –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 3. **Graceful Degradation:**
- –ï—Å–ª–∏ CLIP –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –∫–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞
- –ï—Å–ª–∏ pgvector –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí fallback –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
- –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç ‚Üí –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### 4. **UX:**
- Drag & Drop —É–¥–æ–±–Ω–µ–µ –∫–ª–∏–∫–∞
- Preview –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
- Loading —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
- ESC –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

---

## üìã CHANGELOG:

**12.10.2025:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ü–æ —Ñ–æ—Ç–æ"
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å drag & drop
- ‚úÖ API endpoint –¥–ª—è image search
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å products_list
- ‚úÖ Graceful fallback
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω auth.py (–¥—É–±–ª–∏–∫–∞—Ç –∫–æ–¥–∞)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: Pillow, sentence-transformers

---

## üîÆ –ë–£–î–£–©–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø:

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings** –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
2. **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞** –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ similarity threshold** –≤ UI
4. **–ü–æ–∏—Å–∫ –ø–æ URL** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–µ —Ç–æ–ª—å–∫–æ upload)
5. **Batch upload** (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
6. **Crop & Rotate** –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º

---

## üéâ –°–¢–ê–¢–£–°: –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –∏ –¥–∞–π –∑–Ω–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç!** üöÄ

**Image embeddings generation –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ...**

–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å:
```bash
tail -20 image_embeddings_generation.log
```

---

**–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üí™**




