# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã N+1 –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

## üîç –ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–±–ª–µ–º–∞ N+1?

**N+1** - —ç—Ç–æ –∫–æ–≥–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ N –æ–±—ä–µ–∫—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
- 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ü–µ–Ω—ã)

**–ü—Ä–∏–º–µ—Ä:** –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 20 —Ç–æ–≤–∞—Ä–æ–≤:
- 1 –∑–∞–ø—Ä–æ—Å: –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
- 20 –∑–∞–ø—Ä–æ—Å–æ–≤: –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
- 20 –∑–∞–ø—Ä–æ—Å–æ–≤: –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
- **–ò–¢–û–ì–û: 41 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 1-3!**

---

## ‚ùå –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ N+1

### 1. **`products_list()` - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤** (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `web_interface/app.py`, —Å—Ç—Ä–æ–∫–∏ 449-680

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# 1. –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å - –ø–æ–ª—É—á–∞–µ–º N —Ç–æ–≤–∞—Ä–æ–≤
rows = session.execute(products_sql, {...}).fetchall()

# 2. –î–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞:
for row in rows:
    product = Product()
    # ...
    
    # N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    image_rows = session.execute(images_sql, {"product_id": product.id}).fetchall()
    
    # N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ü–µ–Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    offer_rows = session.execute(offers_sql, {"product_id": product.id}).fetchall()
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å 20 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 20*2 = 41 –∑–∞–ø—Ä–æ—Å**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å 50 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 50*2 = 101 –∑–∞–ø—Ä–æ—Å**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å 100 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 100*2 = 201 –∑–∞–ø—Ä–æ—Å**

**–í–ª–∏—è–Ω–∏–µ:**
- üî¥ **–í–´–°–û–ö–û–ï** - —ç—Ç–æ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–æ–≤
- –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

---

### 2. **`project_detail()` - –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞** (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `web_interface/app.py`, —Å—Ç—Ä–æ–∫–∏ 792-930

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# 1. –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å - –ø–æ–ª—É—á–∞–µ–º N —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
rows = session.execute(products_sql, {"project_id": project_id}).fetchall()

# 2. –î–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞:
for row in rows:
    # N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    image_rows = session.execute(images_sql, {"product_id": product.id}).fetchall()
    
    # N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ü–µ–Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    offer_rows = session.execute(offers_sql, {"product_id": product.id}).fetchall()
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:**
- –ü—Ä–æ–µ–∫—Ç —Å 10 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 10*2 = 21 –∑–∞–ø—Ä–æ—Å**
- –ü—Ä–æ–µ–∫—Ç —Å 30 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 30*2 = 61 –∑–∞–ø—Ä–æ—Å**
- –ü—Ä–æ–µ–∫—Ç —Å 100 —Ç–æ–≤–∞—Ä–∞–º–∏: **1 + 100*2 = 201 –∑–∞–ø—Ä–æ—Å**

**–í–ª–∏—è–Ω–∏–µ:**
- üî¥ **–í–´–°–û–ö–û–ï** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç 50-100+ —Ç–æ–≤–∞—Ä–æ–≤

---

### 3. **`product_detail()` - –î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞** (–ù–ò–ó–ö–û–ï)

**–§–∞–π–ª:** `web_interface/app.py`, —Å—Ç—Ä–æ–∫–∏ 958-1057

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –¢–æ–ª—å–∫–æ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
offer_rows = session.execute(offers_sql, {"product_id": product_id}).fetchall()
image_rows = session.execute(images_sql, {"product_id": product_id}).fetchall()
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:** **1 + 2 = 3 –∑–∞–ø—Ä–æ—Å–∞**

**–í–ª–∏—è–Ω–∏–µ:**
- üü° **–ù–ò–ó–ö–û–ï** - —ç—Ç–æ –¥–µ—Ç–∞–ª–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, 3 –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–µ–º–ª–µ–º–æ
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∏–ª–∏ –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

---

### 4. **`api_kp_get()` - API –ö–ü** (–û–¢–°–£–¢–°–¢–í–£–ï–¢)

**–§–∞–π–ª:** `web_interface/app.py`, —Å—Ç—Ä–æ–∫–∏ 1226-1280

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ù–ï–¢ –ü–†–û–ë–õ–ï–ú–´**

```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ!
result = db_session.execute(text("""
    SELECT 
        ...,
        (SELECT image_url 
         FROM product_images pi 
         WHERE pi.product_id = p.id 
         ...
         LIMIT 1) as main_image_url
    FROM kp_items ki
    JOIN products p ON p.id = ki.product_id
    JOIN price_offers po ON po.id = ki.price_offer_id
    ...
"""))
```

**–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±!** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º.

---

## üìä –û–¶–ï–ù–ö–ê –°–ï–†–¨–ï–ó–ù–û–°–¢–ò

| –°—Ç—Ä–∞–Ω–∏—Ü–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–ø—Ä–æ—Å–æ–≤ (20 —Ç–æ–≤–∞—Ä–æ–≤) |
|----------|----------|-----------|----------------------|
| `products_list()` | ‚ùå N+1 | üî¥ –ö–†–ò–¢–ò–ß–ù–´–ô | 41 |
| `project_detail()` | ‚ùå N+1 | üî¥ –ö–†–ò–¢–ò–ß–ù–´–ô | 41 |
| `product_detail()` | ‚ö†Ô∏è  3 –∑–∞–ø—Ä–æ—Å–∞ | üü° –ù–ò–ó–ö–ò–ô | 3 |
| `api_kp_get()` | ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ | üü¢ –û–ö | 1 |

---

## üí° –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: JOIN —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü—Ä–∏–º–µ—Ä –¥–ª—è `products_list()`:**
```python
products_sql = text("""
    SELECT 
        p.id,
        p.name,
        p.description,
        -- –ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å
        (SELECT image_url 
         FROM product_images pi 
         WHERE pi.product_id = p.id 
         AND pi.is_main_image::text = 'true'
         LIMIT 1) as main_image,
        -- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å
        (SELECT MIN(price_usd) 
         FROM price_offers po 
         WHERE po.product_id = p.id) as min_price
    FROM products p
    WHERE ...
""")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** **1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 41!**

### –í–∞—Ä–∏–∞–Ω—Ç 2: LEFT JOIN + GROUP BY

```python
products_sql = text("""
    SELECT 
        p.id,
        p.name,
        ARRAY_AGG(DISTINCT pi.image_url) as images,
        ARRAY_AGG(po.price_usd) as prices
    FROM products p
    LEFT JOIN product_images pi ON pi.product_id = p.id
    LEFT JOIN price_offers po ON po.product_id = p.id
    WHERE ...
    GROUP BY p.id, p.name
""")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** **1 –∑–∞–ø—Ä–æ—Å** (–Ω–æ —Å–ª–æ–∂–Ω–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (Batch Loading)

```python
# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
products = session.execute(products_sql).fetchall()
product_ids = [p.id for p in products]

# 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
images = session.execute(text("""
    SELECT product_id, image_url, is_main_image
    FROM product_images
    WHERE product_id = ANY(:product_ids)
    ORDER BY product_id
"""), {"product_ids": product_ids}).fetchall()

# 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ü–µ–Ω—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
offers = session.execute(text("""
    SELECT product_id, price_usd, price_rub
    FROM price_offers
    WHERE product_id = ANY(:product_ids)
    ORDER BY product_id, quantity
"""), {"product_ids": product_ids}).fetchall()

# 4. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** **3 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 41**

---

## üìà –û–ñ–ò–î–ê–ï–ú–û–ï –£–õ–£–ß–®–ï–ù–ò–ï

### –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å 50 —Ç–æ–≤–∞—Ä–∞–º–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –°–µ–π—á–∞—Å | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|--------|-------------------|-----------|
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î | 101 | 1-3 | **97-100 –º–µ–Ω—å—à–µ!** |
| –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ | ~500-1000ms | ~50-100ms | **–≤ 10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ** |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è | **-90%** |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
   - ‚úÖ `products_list()` - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
   - ‚úÖ `project_detail()` - –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

2. **–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å:**
   - ‚ö†Ô∏è `product_detail()` - –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (3 –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–µ–º–ª–µ–º–æ)

3. **–ù–µ —Ç—Ä–æ–≥–∞—Ç—å:**
   - ‚úÖ `api_kp_get()` - —É–∂–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ

4. **–ü–æ–¥—Ö–æ–¥:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–í–∞—Ä–∏–∞–Ω—Ç 1** (–ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã) - –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ
   - –î–ª—è –ª–∏—Å—Ç–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –º–∏–Ω/–º–∞–∫—Å —Ü–µ–Ω—ã
   - –î–ª—è –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤—ã–µ 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω - –ø—Ä–æ–±–ª–µ–º–∞ N+1 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
2. ‚è∏Ô∏è –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
3. üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏)
4. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
5. üöÄ –î–µ–ø–ª–æ–π

---

_–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 14 –æ–∫—Ç—è–±—Ä—è 2025_

