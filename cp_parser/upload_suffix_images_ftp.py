"""
–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏ (_1_, _2_, _3_) –Ω–∞ FTP
"""
import sys
from pathlib import Path
from sqlalchemy import text
from ftplib import FTP
import time

sys.path.insert(0, str(Path.cwd()))
from database.postgresql_manager import PostgreSQLManager

class SuffixImageUploader:
    def __init__(self):
        self.db = PostgreSQLManager()
        self.images_dir = Path('storage/images')
        
        # FTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Beget FTP)
        self.ftp_host = 'denbak.beget.tech'
        self.ftp_user = 'denbak_promogo'
        self.ftp_pass = 'C0u5EQi&'
        self.ftp_path = '/public_html/images'
        
    def get_suffix_images(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏"""
        with open('template_4_perfect_ids.txt', 'r') as f:
            project_ids = [int(line.strip()) for line in f if line.strip()]
        
        with self.db.get_session() as session:
            result = session.execute(text("""
                SELECT DISTINCT pi.image_filename
                FROM product_images pi
                JOIN products p ON pi.product_id = p.id
                WHERE p.project_id = ANY(:ids)
                  AND (
                    pi.image_filename LIKE '%_1_%' OR
                    pi.image_filename LIKE '%_2_%' OR
                    pi.image_filename LIKE '%_3_%'
                  )
                ORDER BY pi.image_filename
            """), {'ids': project_ids}).fetchall()
            
            return [row[0] for row in result]
    
    def upload_to_ftp(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ FTP"""
        filenames = self.get_suffix_images()
        total = len(filenames)
        
        print("=" * 100)
        print(f"üì§ –ó–ê–ì–†–£–ó–ö–ê {total:,} –î–û–ü –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –° –°–£–§–§–ò–ö–°–ê–ú–ò –ù–ê FTP")
        print("=" * 100)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ FTP
        print(f"\nüîå –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ {self.ftp_host}...")
        ftp = FTP(self.ftp_host)
        ftp.login(self.ftp_user, self.ftp_pass)
        ftp.cwd(self.ftp_path)
        print(f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ {self.ftp_path}")
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        print(f"\nüìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –Ω–∞ FTP...")
        existing_files = set(ftp.nlst())
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(existing_files):,} —Ñ–∞–π–ª–æ–≤ –Ω–∞ FTP")
        
        uploaded = 0
        skipped = 0
        errors = 0
        start_time = time.time()
        
        print(f"\nüöÄ –ù–ê–ß–ò–ù–ê–Æ –ó–ê–ì–†–£–ó–ö–£:")
        print("-" * 100)
        
        for i, filename in enumerate(filenames, 1):
            try:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
                if filename in existing_files:
                    skipped += 1
                    if i % 100 == 0:
                        elapsed = time.time() - start_time
                        speed = i / elapsed if elapsed > 0 else 0
                        eta = (total - i) / speed if speed > 0 else 0
                        print(f"   ‚è≠Ô∏è  [{i:,}/{total:,}] –ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped:,} | "
                              f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {uploaded:,} | –û—à–∏–±–æ–∫: {errors} | "
                              f"ETA: {eta/60:.1f}–º–∏–Ω")
                    continue
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
                file_path = self.images_dir / filename
                if not file_path.exists():
                    errors += 1
                    print(f"   ‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {filename}")
                    continue
                
                # –ó–∞–≥—Ä—É–∂–∞–µ–º
                with open(file_path, 'rb') as f:
                    ftp.storbinary(f'STOR {filename}', f)
                
                uploaded += 1
                
                # –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 50 —Ñ–∞–π–ª–æ–≤
                if uploaded % 50 == 0:
                    elapsed = time.time() - start_time
                    speed = i / elapsed if elapsed > 0 else 0
                    eta = (total - i) / speed if speed > 0 else 0
                    print(f"   ‚úÖ [{i:,}/{total:,}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {uploaded:,} | "
                          f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped:,} | –û—à–∏–±–æ–∫: {errors} | "
                          f"–°–∫–æ—Ä–æ—Å—Ç—å: {speed:.1f} —Ñ–∞–π–ª–æ–≤/—Å–µ–∫ | ETA: {eta/60:.1f}–º–∏–Ω")
            
            except Exception as e:
                errors += 1
                print(f"   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {filename}: {str(e)[:50]}")
        
        ftp.quit()
        
        elapsed = time.time() - start_time
        
        print("\n" + "=" * 100)
        print(f"‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!")
        print(f"   –ó–∞–≥—Ä—É–∂–µ–Ω–æ:  {uploaded:,}")
        print(f"   –ü—Ä–æ–ø—É—â–µ–Ω–æ:  {skipped:,}")
        print(f"   –û—à–∏–±–æ–∫:     {errors}")
        print(f"   –í—Ä–µ–º—è:      {elapsed/60:.1f} –º–∏–Ω—É—Ç")
        print(f"   –°–∫–æ—Ä–æ—Å—Ç—å:   {total/elapsed:.1f} —Ñ–∞–π–ª–æ–≤/—Å–µ–∫")
        print("=" * 100)

if __name__ == "__main__":
    uploader = SuffixImageUploader()
    uploader.upload_to_ftp()

